function mxMedianHybridCrossingReduction(a){this.layout=a}mxMedianHybridCrossingReduction.prototype=new mxHierarchicalLayoutStage();mxMedianHybridCrossingReduction.prototype.constructor=mxMedianHybridCrossingReduction;mxMedianHybridCrossingReduction.prototype.layout=null;mxMedianHybridCrossingReduction.prototype.maxIterations=24;mxMedianHybridCrossingReduction.prototype.nestedBestRanks=null;mxMedianHybridCrossingReduction.prototype.currentBestCrossings=0;mxMedianHybridCrossingReduction.prototype.iterationsWithoutImprovement=0;mxMedianHybridCrossingReduction.prototype.maxNoImprovementIterations=2;mxMedianHybridCrossingReduction.prototype.execute=function(n){var g=this.layout.getModel();this.nestedBestRanks=[];for(var e=0;e<g.ranks.length;e++){this.nestedBestRanks[e]=g.ranks[e].slice()}var a=0;var h=this.calculateCrossings(g);for(var e=0;e<this.maxIterations&&a<this.maxNoImprovementIterations;e++){this.weightedMedian(e,g);this.transpose(e,g);var m=this.calculateCrossings(g);if(m<h){h=m;a=0;for(var c=0;c<this.nestedBestRanks.length;c++){var d=g.ranks[c];for(var b=0;b<d.length;b++){var o=d[b];this.nestedBestRanks[c][o.getGeneralPurposeVariable(c)]=o}}}else{a++;for(var c=0;c<this.nestedBestRanks.length;c++){var d=g.ranks[c];for(var b=0;b<d.length;b++){var o=d[b];o.setGeneralPurposeVariable(c,b)}}}if(h==0){break}}var f=[];var l=[];for(var e=0;e<g.maxRank+1;e++){l[e]=[];f[e]=l[e]}for(var e=0;e<this.nestedBestRanks.length;e++){for(var c=0;c<this.nestedBestRanks[e].length;c++){l[e].push(this.nestedBestRanks[e][c])}}g.ranks=f};mxMedianHybridCrossingReduction.prototype.calculateCrossings=function(b){var d=b.ranks.length;var a=0;for(var c=1;c<d;c++){a+=this.calculateRankCrossing(c,b)}return a};mxMedianHybridCrossingReduction.prototype.calculateRankCrossing=function(t,b){var f=0;var v=b.ranks[t];var s=b.ranks[t-1];var n=[];for(var r=0;r<v.length;r++){var o=v[r];var u=o.getGeneralPurposeVariable(t);var w=o.getPreviousLayerConnectedCells(t);var e=[];for(var p=0;p<w.length;p++){var q=w[p];var g=q.getGeneralPurposeVariable(t-1);e.push(g)}e.sort(function(i,j){return i-j});n[u]=e}var c=[];for(var r=0;r<n.length;r++){c=c.concat(n[r])}var a=1;while(a<s.length){a<<=1}var l=2*a-1;a-=1;var h=[];for(var r=0;r<l;++r){h[r]=0}for(var r=0;r<c.length;r++){var d=c[r];var m=d+a;++h[m];while(m>0){if(m%2){f+=h[m+1]}m=(m-1)>>1;++h[m]}}return f};mxMedianHybridCrossingReduction.prototype.transpose=function(a,f){var b=true;var n=0;var q=10;while(b&&n++<q){var s=a%2==1&&n%2==1;b=false;for(var y=0;y<f.ranks.length;y++){var z=f.ranks[y];var C=[];for(var x=0;x<z.length;x++){var d=z[x];var B=d.getGeneralPurposeVariable(y);if(B<0){B=x}C[B]=d}var t=null;var m=null;var g=null;var r=null;var e=null;var w=null;var D=null;var c=null;var l=null;var v=null;for(var x=0;x<(z.length-1);x++){if(x==0){l=C[x];t=l.getNextLayerConnectedCells(y);m=l.getPreviousLayerConnectedCells(y);e=[];w=[];for(var u=0;u<t.length;u++){e[u]=t[u].getGeneralPurposeVariable(y+1)}for(var u=0;u<m.length;u++){w[u]=m[u].getGeneralPurposeVariable(y-1)}}else{t=g;m=r;e=D;w=c;l=v}v=C[x+1];g=v.getNextLayerConnectedCells(y);r=v.getPreviousLayerConnectedCells(y);D=[];c=[];for(var u=0;u<g.length;u++){D[u]=g[u].getGeneralPurposeVariable(y+1)}for(var u=0;u<r.length;u++){c[u]=r[u].getGeneralPurposeVariable(y-1)}var h=0;var o=0;for(var u=0;u<e.length;u++){for(var p=0;p<D.length;p++){if(e[u]>D[p]){h++}if(e[u]<D[p]){o++}}}for(var u=0;u<w.length;u++){for(var p=0;p<c.length;p++){if(w[u]>c[p]){h++}if(w[u]<c[p]){o++}}}if((o<h)||(o==h&&s)){var A=l.getGeneralPurposeVariable(y);l.setGeneralPurposeVariable(y,v.getGeneralPurposeVariable(y));v.setGeneralPurposeVariable(y,A);g=t;r=m;D=e;c=w;v=l;if(!s){b=true}}}}}};mxMedianHybridCrossingReduction.prototype.weightedMedian=function(c,b){var d=(c%2==0);if(d){for(var a=b.maxRank-1;a>=0;a--){this.medianRank(a,d)}}else{for(var a=1;a<b.maxRank;a++){this.medianRank(a,d)}}};mxMedianHybridCrossingReduction.prototype.medianRank=function(k,g){var b=this.nestedBestRanks[k].length;var f=[];var h=[];for(var c=0;c<b;c++){var j=this.nestedBestRanks[k][c];var e=new MedianCellSorter();e.cell=j;var a;if(g){a=j.getNextLayerConnectedCells(k)}else{a=j.getPreviousLayerConnectedCells(k)}var d;if(g){d=k+1}else{d=k-1}if(a!=null&&a.length!=0){e.medianValue=this.medianValue(a,d);f.push(e)}else{h[j.getGeneralPurposeVariable(k)]=true}}f.sort(MedianCellSorter.prototype.compare);for(var c=0;c<b;c++){if(h[c]==null){var j=f.shift().cell;j.setGeneralPurposeVariable(k,c)}}};mxMedianHybridCrossingReduction.prototype.medianValue=function(e,j){var f=[];var g=0;for(var b=0;b<e.length;b++){var h=e[b];f[g++]=h.getGeneralPurposeVariable(j)}f.sort(function(k,i){return k-i});if(g%2==1){return f[Math.floor(g/2)]}else{if(g==2){return((f[0]+f[1])/2)}else{var c=g/2;var d=f[c-1]-f[0];var a=f[g-1]-f[c];return(f[c-1]*a+f[c]*d)/(d+a)}}};function MedianCellSorter(){}MedianCellSorter.prototype.medianValue=0;MedianCellSorter.prototype.cell=false;MedianCellSorter.prototype.compare=function(d,c){if(d!=null&&c!=null){if(c.medianValue>d.medianValue){return -1}else{if(c.medianValue<d.medianValue){return 1}else{return 0}}}else{return 0}};