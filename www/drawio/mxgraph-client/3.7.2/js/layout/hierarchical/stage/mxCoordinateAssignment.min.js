function mxCoordinateAssignment(e,b,f,c,d,a){this.layout=e;this.intraCellSpacing=b;this.interRankCellSpacing=f;this.orientation=c;this.initialX=d;this.parallelEdgeSpacing=a}mxCoordinateAssignment.prototype=new mxHierarchicalLayoutStage();mxCoordinateAssignment.prototype.constructor=mxCoordinateAssignment;mxCoordinateAssignment.prototype.layout=null;mxCoordinateAssignment.prototype.intraCellSpacing=30;mxCoordinateAssignment.prototype.interRankCellSpacing=100;mxCoordinateAssignment.prototype.parallelEdgeSpacing=10;mxCoordinateAssignment.prototype.maxIterations=8;mxCoordinateAssignment.prototype.prefHozEdgeSep=5;mxCoordinateAssignment.prototype.prefVertEdgeOff=2;mxCoordinateAssignment.prototype.minEdgeJetty=12;mxCoordinateAssignment.prototype.channelBuffer=4;mxCoordinateAssignment.prototype.jettyPositions=null;mxCoordinateAssignment.prototype.orientation=mxConstants.DIRECTION_NORTH;mxCoordinateAssignment.prototype.initialX=null;mxCoordinateAssignment.prototype.limitX=null;mxCoordinateAssignment.prototype.currentXDelta=null;mxCoordinateAssignment.prototype.widestRank=null;mxCoordinateAssignment.prototype.rankTopY=null;mxCoordinateAssignment.prototype.rankBottomY=null;mxCoordinateAssignment.prototype.widestRankValue=null;mxCoordinateAssignment.prototype.rankWidths=null;mxCoordinateAssignment.prototype.rankY=null;mxCoordinateAssignment.prototype.fineTuning=true;mxCoordinateAssignment.prototype.nextLayerConnectedCache=null;mxCoordinateAssignment.prototype.previousLayerConnectedCache=null;mxCoordinateAssignment.prototype.groupPadding=10;mxCoordinateAssignment.prototype.printStatus=function(){var d=this.layout.getModel();mxLog.show();mxLog.writeln("======Coord assignment debug=======");for(var c=0;c<d.ranks.length;c++){mxLog.write("Rank ",c," : ");var e=d.ranks[c];for(var b=0;b<e.length;b++){var a=e[b];mxLog.write(a.getGeneralPurposeVariable(c),"  ")}mxLog.writeln()}mxLog.writeln("====================================")};mxCoordinateAssignment.prototype.execute=function(g){this.jettyPositions=Object();var d=this.layout.getModel();this.currentXDelta=0;this.initialCoords(this.layout.getGraph(),d);if(this.fineTuning){this.minNode(d)}var f=100000000;if(this.fineTuning){for(var e=0;e<this.maxIterations;e++){if(e!=0){this.medianPos(e,d);this.minNode(d)}if(this.currentXDelta<f){for(var c=0;c<d.ranks.length;c++){var h=d.ranks[c];for(var b=0;b<h.length;b++){var a=h[b];a.setX(c,a.getGeneralPurposeVariable(c))}}f=this.currentXDelta}else{for(var c=0;c<d.ranks.length;c++){var h=d.ranks[c];for(var b=0;b<h.length;b++){var a=h[b];a.setGeneralPurposeVariable(c,a.getX(c))}}}this.minPath(this.layout.getGraph(),d);this.currentXDelta=0}}this.setCellLocations(this.layout.getGraph(),d)};mxCoordinateAssignment.prototype.minNode=function(h){var G=[];var H=new mxDictionary();var F=[];for(var C=0;C<=h.maxRank;C++){F[C]=h.ranks[C];for(var B=0;B<F[C].length;B++){var w=F[C][B];var o=new WeightedCellSorter(w,C);o.rankIndex=B;o.visited=true;G.push(o);H.put(w,o)}}var A=G.length*10;var m=0;var D=1;while(G.length>0&&m<=A){var e=G.shift();var d=e.cell;var z=e.weightedValue;var p=parseInt(e.rankIndex);var v=d.getNextLayerConnectedCells(z);var b=d.getPreviousLayerConnectedCells(z);var t=v.length;var r=b.length;var n=this.medianXValue(v,z+1);var c=this.medianXValue(b,z-1);var x=t+r;var s=d.getGeneralPurposeVariable(z);var E=s;if(x>0){E=(n*t+c*r)/x}var a=false;if(E<s-D){if(p==0){d.setGeneralPurposeVariable(z,E);a=true}else{var l=F[z][p-1];var g=l.getGeneralPurposeVariable(z);g=g+l.width/2+this.intraCellSpacing+d.width/2;if(g<E){d.setGeneralPurposeVariable(z,E);a=true}else{if(g<d.getGeneralPurposeVariable(z)-D){d.setGeneralPurposeVariable(z,g);a=true}}}}else{if(E>s+D){var q=F[z].length;if(p==q-1){d.setGeneralPurposeVariable(z,E);a=true}else{var y=F[z][p+1];var k=y.getGeneralPurposeVariable(z);k=k-y.width/2-this.intraCellSpacing-d.width/2;if(k>E){d.setGeneralPurposeVariable(z,E);a=true}else{if(k>d.getGeneralPurposeVariable(z)+D){d.setGeneralPurposeVariable(z,k);a=true}}}}}if(a){for(var C=0;C<v.length;C++){var f=v[C];var u=H.get(f);if(u!=null){if(u.visited==false){u.visited=true;G.push(u)}}}for(var C=0;C<b.length;C++){var f=b[C];var u=H.get(f);if(u!=null){if(u.visited==false){u.visited=true;G.push(u)}}}}e.visited=false;m++}};mxCoordinateAssignment.prototype.medianPos=function(c,b){var d=(c%2==0);if(d){for(var a=b.maxRank;a>0;a--){this.rankMedianPosition(a-1,b,a)}}else{for(var a=0;a<b.maxRank-1;a++){this.rankMedianPosition(a+1,b,a)}}};mxCoordinateAssignment.prototype.rankMedianPosition=function(p,c,m){var s=c.ranks[p];var g=[];var h=new Object();for(var r=0;r<s.length;r++){var l=s[r];g[r]=new WeightedCellSorter();g[r].cell=l;g[r].rankIndex=r;h[l.id]=g[r];var n=null;if(m<p){n=l.getPreviousLayerConnectedCells(p)}else{n=l.getNextLayerConnectedCells(p)}g[r].weightedValue=this.calculatedWeightedValue(l,n)}g.sort(WeightedCellSorter.prototype.compare);for(var r=0;r<g.length;r++){var k=0;var a=g[r].cell;var n=null;var f=0;if(m<p){n=a.getPreviousLayerConnectedCells(p).slice()}else{n=a.getNextLayerConnectedCells(p).slice()}if(n!=null){k=n.length;if(k>0){f=this.medianXValue(n,m)}else{f=a.getGeneralPurposeVariable(p)}}var u=0;var b=-100000000;for(var q=g[r].rankIndex-1;q>=0;){var t=h[s[q].id];if(t!=null){var e=t.cell;if(t.visited){b=e.getGeneralPurposeVariable(p)+e.width/2+this.intraCellSpacing+u+a.width/2;q=-1}else{u+=e.width+this.intraCellSpacing;q--}}}var v=0;var d=100000000;for(var q=g[r].rankIndex+1;q<g.length;){var t=h[s[q].id];if(t!=null){var o=t.cell;if(t.visited){d=o.getGeneralPurposeVariable(p)-o.width/2-this.intraCellSpacing-v-a.width/2;q=g.length}else{v+=o.width+this.intraCellSpacing;q++}}}if(f>=b&&f<=d){a.setGeneralPurposeVariable(p,f)}else{if(f<b){a.setGeneralPurposeVariable(p,b);this.currentXDelta+=b-f}else{if(f>d){a.setGeneralPurposeVariable(p,d);this.currentXDelta+=f-d}}}g[r].visited=true}};mxCoordinateAssignment.prototype.calculatedWeightedValue=function(e,d){var b=0;for(var c=0;c<d.length;c++){var a=d[c];if(e.isVertex()&&a.isVertex()){b++}else{if(e.isEdge()&&a.isEdge()){b+=8}else{b+=2}}}return b};mxCoordinateAssignment.prototype.medianXValue=function(c,g){if(c.length==0){return 0}var a=[];for(var f=0;f<c.length;f++){a[f]=c[f].getGeneralPurposeVariable(g)}a.sort(function(i,h){return i-h});if(c.length%2==1){return a[Math.floor(c.length/2)]}else{var e=c.length/2;var b=a[e-1];var d=a[e];return((b+d)/2)}};mxCoordinateAssignment.prototype.initialCoords=function(c,a){this.calculateWidestRank(c,a);for(var b=this.widestRank;b>=0;b--){if(b<a.maxRank){this.rankCoordinates(b,c,a)}}for(var b=this.widestRank+1;b<=a.maxRank;b++){if(b>0){this.rankCoordinates(b,c,a)}}};mxCoordinateAssignment.prototype.rankCoordinates=function(l,k,j){var g=j.ranks[l];var b=0;var e=this.initialX+(this.widestRankValue-this.rankWidths[l])/2;var c=false;for(var h=0;h<g.length;h++){var d=g[h];if(d.isVertex()){var a=this.layout.getVertexBounds(d.cell);if(a!=null){if(this.orientation==mxConstants.DIRECTION_NORTH||this.orientation==mxConstants.DIRECTION_SOUTH){d.width=a.width;d.height=a.height}else{d.width=a.height;d.height=a.width}}else{c=true}b=Math.max(b,d.height)}else{if(d.isEdge()){var f=1;if(d.edges!=null){f=d.edges.length}else{mxLog.warn("edge.edges is null")}d.width=(f-1)*this.parallelEdgeSpacing}}e+=d.width/2;d.setX(l,e);d.setGeneralPurposeVariable(l,e);e+=d.width/2;e+=this.intraCellSpacing}if(c==true){mxLog.warn("At least one cell has no bounds")}};mxCoordinateAssignment.prototype.calculateWidestRank=function(o,l){var m=-this.interRankCellSpacing;var e=0;this.rankWidths=[];this.rankY=[];for(var p=l.maxRank;p>=0;p--){var b=0;var k=l.ranks[p];var f=this.initialX;var c=false;for(var j=0;j<k.length;j++){var d=k[j];if(d.isVertex()){var a=this.layout.getVertexBounds(d.cell);if(a!=null){if(this.orientation==mxConstants.DIRECTION_NORTH||this.orientation==mxConstants.DIRECTION_SOUTH){d.width=a.width;d.height=a.height}else{d.width=a.height;d.height=a.width}}else{c=true}b=Math.max(b,d.height)}else{if(d.isEdge()){var h=1;if(d.edges!=null){h=d.edges.length}else{mxLog.warn("edge.edges is null")}d.width=(h-1)*this.parallelEdgeSpacing}}f+=d.width/2;d.setX(p,f);d.setGeneralPurposeVariable(p,f);f+=d.width/2;f+=this.intraCellSpacing;if(f>this.widestRankValue){this.widestRankValue=f;this.widestRank=p}this.rankWidths[p]=f}if(c==true){mxLog.warn("At least one cell has no bounds")}this.rankY[p]=m;var g=b/2+e/2+this.interRankCellSpacing;e=b;if(this.orientation==mxConstants.DIRECTION_NORTH||this.orientation==mxConstants.DIRECTION_WEST){m+=g}else{m-=g}for(var j=0;j<k.length;j++){var n=k[j];n.setY(p,m)}}};mxCoordinateAssignment.prototype.minPath=function(p,g){var e=g.edgeMapper.getValues();for(var d=0;d<e.length;d++){var o=e[d];if(o.maxRank-o.minRank-1<1){continue}var a=o.getGeneralPurposeVariable(o.minRank+1);var h=true;var l=0;for(var f=o.minRank+2;f<o.maxRank;f++){var m=o.getGeneralPurposeVariable(f);if(a!=m){h=false;a=m}else{l++}}if(!h){var c=0;var n=0;var q=[];var k=[];var b=o.getGeneralPurposeVariable(o.minRank+1);for(var f=o.minRank+1;f<o.maxRank-1;f++){var r=o.getX(f+1);if(b==r){q[f-o.minRank-1]=b;c++}else{if(this.repositionValid(g,o,f+1,b)){q[f-o.minRank-1]=b;c++}else{q[f-o.minRank-1]=r;b=r}}}b=o.getX(f);for(var f=o.maxRank-1;f>o.minRank+1;f--){var r=o.getX(f-1);if(b==r){k[f-o.minRank-2]=b;n++}else{if(this.repositionValid(g,o,f-1,b)){k[f-o.minRank-2]=b;n++}else{k[f-o.minRank-2]=o.getX(f-1);b=r}}}if(n>l||c>l){if(n>=c){for(var f=o.maxRank-2;f>o.minRank;f--){o.setX(f,k[f-o.minRank-1])}}else{if(c>n){for(var f=o.minRank+2;f<o.maxRank;f++){o.setX(f,q[f-o.minRank-2])}}else{}}}}}};mxCoordinateAssignment.prototype.repositionValid=function(e,l,c,f){var k=e.ranks[c];var h=-1;for(var d=0;d<k.length;d++){if(l==k[d]){h=d;break}}if(h<0){return false}var a=l.getGeneralPurposeVariable(c);if(f<a){if(h==0){return true}var j=k[h-1];var g=j.getGeneralPurposeVariable(c);g=g+j.width/2+this.intraCellSpacing+l.width/2;if(g<=f){return true}else{return false}}else{if(f>a){if(h==k.length-1){return true}var b=k[h+1];var m=b.getGeneralPurposeVariable(c);m=m-b.width/2-this.intraCellSpacing-l.width/2;if(m>=f){return true}else{return false}}}return true};mxCoordinateAssignment.prototype.setCellLocations=function(e,c){this.rankTopY=[];this.rankBottomY=[];for(var d=0;d<c.ranks.length;d++){this.rankTopY[d]=Number.MAX_VALUE;this.rankBottomY[d]=-Number.MAX_VALUE}var b=c.vertexMapper.getValues();for(var d=0;d<b.length;d++){this.setVertexLocation(b[d])}if(this.layout.edgeStyle==mxHierarchicalEdgeStyle.ORTHOGONAL||this.layout.edgeStyle==mxHierarchicalEdgeStyle.POLYLINE||this.layout.edgeStyle==mxHierarchicalEdgeStyle.CURVE){this.localEdgeProcessing(c)}var a=c.edgeMapper.getValues();for(var d=0;d<a.length;d++){this.setEdgePosition(a[d])}};mxCoordinateAssignment.prototype.localEdgeProcessing=function(h){for(var q=0;q<h.ranks.length;q++){var B=h.ranks[q];for(var s=0;s<B.length;s++){var c=B[s];if(c.isVertex()){var E=c.getPreviousLayerConnectedCells(q);var n=q-1;for(var z=0;z<2;z++){if(n>-1&&n<h.ranks.length&&E!=null&&E.length>0){var r=[];for(var A=0;A<E.length;A++){var y=new WeightedCellSorter(E[A],E[A].getX(n));r.push(y)}r.sort(WeightedCellSorter.prototype.compare);var g=c.x[0]-c.width/2;var i=g+c.width;var o=0;var p=0;var C=[];for(var A=0;A<r.length;A++){var D=r[A].cell;var u;if(D.isVertex()){if(z==0){u=c.connectsAsSource}else{u=c.connectsAsTarget}for(var a=0;a<u.length;a++){if(u[a].source==D||u[a].target==D){o+=u[a].edges.length;p++;C.push(u[a])}}}else{o+=D.edges.length;p++;C.push(D)}}var f=(o+1)*this.prefHozEdgeSep;if(c.width>f+(2*this.prefHozEdgeSep)){g+=this.prefHozEdgeSep;i-=this.prefHozEdgeSep}var b=i-g;var e=b/o;var x=g+e/2;var t=this.minEdgeJetty-this.prefVertEdgeOff;var d=0;for(var A=0;A<C.length;A++){var v=C[A].edges.length;var l=this.jettyPositions[C[A].ids[0]];if(l==null){l=[];this.jettyPositions[C[A].ids[0]]=l}if(A<o/2){t+=this.prefVertEdgeOff}else{if(A>o/2){t-=this.prefVertEdgeOff}}for(var w=0;w<v;w++){l[w*4+z*2]=x;x+=e;l[w*4+z*2+1]=t}d=Math.max(d,t)}}E=c.getNextLayerConnectedCells(q);n=q+1}}}}};mxCoordinateAssignment.prototype.setEdgePosition=function(b){var F=0;if(b.temp[0]!=101207){var p=b.maxRank;var k=b.minRank;if(p==k){p=b.source.maxRank;k=b.target.minRank}var E=0;var u=this.jettyPositions[b.ids[0]];var B=b.isReversed?b.target.cell:b.source.cell;var c=this.layout.graph;var g=this.orientation==mxConstants.DIRECTION_EAST||this.orientation==mxConstants.DIRECTION_SOUTH;for(var D=0;D<b.edges.length;D++){var q=b.edges[D];var l=this.layout.getVisibleTerminal(q,true);var G=[];var d=b.isReversed;if(l!=B){d=!d}if(u!=null){var v=d?2:0;var r=d?(g?this.rankBottomY[k]:this.rankTopY[k]):(g?this.rankTopY[p]:this.rankBottomY[p]);var w=u[E*4+1+v];if(d!=g){w=-w}r+=w;var t=u[E*4+v];var J=c.model.getTerminal(q,true);if(this.layout.isPort(J)&&c.model.getParent(J)==l){var h=c.view.getState(J);if(h!=null){t=h.x}else{t=l.geometry.x+b.source.width*J.geometry.x}}if(this.orientation==mxConstants.DIRECTION_NORTH||this.orientation==mxConstants.DIRECTION_SOUTH){G.push(new mxPoint(t,r));if(this.layout.edgeStyle==mxHierarchicalEdgeStyle.CURVE){G.push(new mxPoint(t,r+w))}}else{G.push(new mxPoint(r,t));if(this.layout.edgeStyle==mxHierarchicalEdgeStyle.CURVE){G.push(new mxPoint(r+w,t))}}}var s=b.x.length-1;var a=-1;var e=-1;var n=b.maxRank-1;if(d){s=0;a=b.x.length;e=1;n=b.minRank+1}for(var C=s;(b.maxRank!=b.minRank)&&C!=a;C+=e){var I=b.x[C]+F;var z=(this.rankTopY[n]+this.rankBottomY[n+1])/2;var o=(this.rankTopY[n-1]+this.rankBottomY[n])/2;if(d){var H=z;z=o;o=H}if(this.orientation==mxConstants.DIRECTION_NORTH||this.orientation==mxConstants.DIRECTION_SOUTH){G.push(new mxPoint(I,z));G.push(new mxPoint(I,o))}else{G.push(new mxPoint(z,I));G.push(new mxPoint(o,I))}this.limitX=Math.max(this.limitX,I);n+=e}if(u!=null){var v=d?2:0;var f=d?(g?this.rankTopY[p]:this.rankBottomY[p]):(g?this.rankBottomY[k]:this.rankTopY[k]);var w=u[E*4+3-v];if(d!=g){w=-w}var r=f-w;var t=u[E*4+2-v];var m=c.model.getTerminal(q,false);var A=this.layout.getVisibleTerminal(q,false);if(this.layout.isPort(m)&&c.model.getParent(m)==A){var h=c.view.getState(m);if(h!=null){t=h.x}else{t=A.geometry.x+b.target.width*m.geometry.x}}if(this.orientation==mxConstants.DIRECTION_NORTH||this.orientation==mxConstants.DIRECTION_SOUTH){if(this.layout.edgeStyle==mxHierarchicalEdgeStyle.CURVE){G.push(new mxPoint(t,r-w))}G.push(new mxPoint(t,r))}else{if(this.layout.edgeStyle==mxHierarchicalEdgeStyle.CURVE){G.push(new mxPoint(r-w,t))}G.push(new mxPoint(r,t))}}if(b.isReversed){this.processReversedEdge(b,q)}this.layout.setEdgePoints(q,G);if(F==0){F=this.parallelEdgeSpacing}else{if(F>0){F=-F}else{F=-F+this.parallelEdgeSpacing}}E++}b.temp[0]=101207}};mxCoordinateAssignment.prototype.setVertexLocation=function(b){var a=b.cell;var d=b.x[0]-b.width/2;var c=b.y[0]-b.height/2;this.rankTopY[b.minRank]=Math.min(this.rankTopY[b.minRank],c);this.rankBottomY[b.minRank]=Math.max(this.rankBottomY[b.minRank],c+b.height);if(this.orientation==mxConstants.DIRECTION_NORTH||this.orientation==mxConstants.DIRECTION_SOUTH){this.layout.setVertexLocation(a,d,c)}else{this.layout.setVertexLocation(a,c,d)}this.limitX=Math.max(this.limitX,d+b.width)};mxCoordinateAssignment.prototype.processReversedEdge=function(b,a){};function WeightedCellSorter(a,b){this.cell=a;this.weightedValue=b}WeightedCellSorter.prototype.weightedValue=0;WeightedCellSorter.prototype.nudge=false;WeightedCellSorter.prototype.visited=false;WeightedCellSorter.prototype.rankIndex=null;WeightedCellSorter.prototype.cell=null;WeightedCellSorter.prototype.compare=function(d,c){if(d!=null&&c!=null){if(c.weightedValue>d.weightedValue){return -1}else{if(c.weightedValue<d.weightedValue){return 1}else{if(c.nudge){return -1}else{return 1}}}}else{return 0}};