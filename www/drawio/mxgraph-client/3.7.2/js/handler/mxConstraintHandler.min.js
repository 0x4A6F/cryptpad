function mxConstraintHandler(a){this.graph=a;this.resetHandler=mxUtils.bind(this,function(c,b){if(this.currentFocus!=null&&this.graph.view.getState(this.currentFocus.cell)==null){this.reset()}else{this.redraw()}});this.graph.model.addListener(mxEvent.CHANGE,this.resetHandler);this.graph.view.addListener(mxEvent.SCALE,this.resetHandler);this.graph.addListener(mxEvent.ROOT,this.resetHandler)}mxConstraintHandler.prototype.pointImage=new mxImage(mxClient.imageBasePath+"/point.gif",5,5);mxConstraintHandler.prototype.graph=null;mxConstraintHandler.prototype.enabled=true;mxConstraintHandler.prototype.highlightColor=mxConstants.DEFAULT_VALID_COLOR;mxConstraintHandler.prototype.isEnabled=function(){return this.enabled};mxConstraintHandler.prototype.setEnabled=function(a){this.enabled=a};mxConstraintHandler.prototype.reset=function(){if(this.focusIcons!=null){for(var a=0;a<this.focusIcons.length;a++){this.focusIcons[a].destroy()}this.focusIcons=null}if(this.focusHighlight!=null){this.focusHighlight.destroy();this.focusHighlight=null}this.currentConstraint=null;this.currentFocusArea=null;this.currentPoint=null;this.currentFocus=null;this.focusPoints=null};mxConstraintHandler.prototype.getTolerance=function(a){return this.graph.getTolerance()};mxConstraintHandler.prototype.getImageForConstraint=function(b,c,a){return this.pointImage};mxConstraintHandler.prototype.isEventIgnored=function(a,b){return false};mxConstraintHandler.prototype.isStateIgnored=function(b,a){return false};mxConstraintHandler.prototype.destroyIcons=function(){if(this.focusIcons!=null){for(var a=0;a<this.focusIcons.length;a++){this.focusIcons[a].destroy()}this.focusIcons=null;this.focusPoints=null}};mxConstraintHandler.prototype.destroyFocusHighlight=function(){if(this.focusHighlight!=null){this.focusHighlight.destroy();this.focusHighlight=null}};mxConstraintHandler.prototype.isKeepFocusEvent=function(a){return mxEvent.isShiftDown(a.getEvent())};mxConstraintHandler.prototype.getCellForEvent=function(d,b){var a=d.getCell();if(a==null&&b!=null&&(d.getGraphX()!=b.x||d.getGraphY()!=b.y)){a=this.graph.getCellAt(b.x,b.y)}if(a!=null&&!this.graph.isCellConnectable(a)){var c=this.graph.getModel().getParent(a);if(this.graph.getModel().isVertex(c)&&this.graph.isCellConnectable(c)){a=c}}return a};mxConstraintHandler.prototype.update=function(t,m,q,o){if(this.isEnabled()&&!this.isEventIgnored(t)){if(this.mouseleaveHandler==null&&this.graph.container!=null){this.mouseleaveHandler=mxUtils.bind(this,function(){this.reset()});mxEvent.addListener(this.graph.container,"mouseleave",this.resetHandler)}var l=this.getTolerance(t);var g=(o!=null)?o.x:t.getGraphX();var f=(o!=null)?o.y:t.getGraphY();var a=new mxRectangle(g-l,f-l,2*l,2*l);var k=new mxRectangle(t.getGraphX()-l,t.getGraphY()-l,2*l,2*l);var e=this.graph.view.getState(this.getCellForEvent(t,o));if(!this.isKeepFocusEvent(t)&&(this.currentFocusArea==null||this.currentFocus==null||(e!=null)||!this.graph.getModel().isVertex(this.currentFocus.cell)||!mxUtils.intersects(this.currentFocusArea,k))&&(e!=this.currentFocus)){this.currentFocusArea=null;this.currentFocus=null;this.setFocus(t,e,m)}this.currentConstraint=null;this.currentPoint=null;var r=null;if(this.focusIcons!=null&&this.constraints!=null&&(e==null||this.currentFocus==e)){var d=k.getCenterX();var c=k.getCenterY();for(var p=0;p<this.focusIcons.length;p++){var j=d-this.focusIcons[p].bounds.getCenterX();var h=c-this.focusIcons[p].bounds.getCenterY();var s=j*j+h*h;if((this.intersects(this.focusIcons[p],k,m,q)||(o!=null&&this.intersects(this.focusIcons[p],a,m,q)))&&(r==null||s<r)){this.currentConstraint=this.constraints[p];this.currentPoint=this.focusPoints[p];r=s;var s=this.focusIcons[p].bounds.clone();s.grow(mxConstants.HIGHLIGHT_SIZE);if(mxClient.IS_IE){s.grow(1);s.width-=1;s.height-=1}if(this.focusHighlight==null){var b=this.createHighlightShape();b.dialect=(this.graph.dialect==mxConstants.DIALECT_SVG)?mxConstants.DIALECT_SVG:mxConstants.DIALECT_VML;b.pointerEvents=false;b.init(this.graph.getView().getOverlayPane());this.focusHighlight=b;var n=mxUtils.bind(this,function(){return(this.currentFocus!=null)?this.currentFocus:e});mxEvent.redirectMouseEvents(b.node,this.graph,n)}this.focusHighlight.bounds=s;this.focusHighlight.redraw()}}}if(this.currentConstraint==null){this.destroyFocusHighlight()}}else{this.currentConstraint=null;this.currentFocus=null;this.currentPoint=null}};mxConstraintHandler.prototype.redraw=function(){if(this.currentFocus!=null&&this.constraints!=null&&this.focusIcons!=null){var d=this.graph.view.getState(this.currentFocus.cell);this.currentFocus=d;this.currentFocusArea=new mxRectangle(d.x,d.y,d.width,d.height);for(var b=0;b<this.constraints.length;b++){var e=this.graph.getConnectionPoint(d,this.constraints[b]);var a=this.getImageForConstraint(d,this.constraints[b],e);var c=new mxRectangle(Math.round(e.x-a.width/2),Math.round(e.y-a.height/2),a.width,a.height);this.focusIcons[b].bounds=c;this.focusIcons[b].redraw();this.currentFocusArea.add(this.focusIcons[b].bounds);this.focusPoints[b]=e}}};mxConstraintHandler.prototype.setFocus=function(j,d,b){this.constraints=(d!=null&&!this.isStateIgnored(d,b)&&this.graph.isCellConnectable(d.cell))?((this.isEnabled())?(this.graph.getAllConnectionConstraints(d,b)||[]):[]):null;if(this.constraints!=null){this.currentFocus=d;this.currentFocusArea=new mxRectangle(d.x,d.y,d.width,d.height);if(this.focusIcons!=null){for(var e=0;e<this.focusIcons.length;e++){this.focusIcons[e].destroy()}this.focusIcons=null;this.focusPoints=null}this.focusPoints=[];this.focusIcons=[];for(var e=0;e<this.constraints.length;e++){var h=this.graph.getConnectionPoint(d,this.constraints[e]);var f=this.getImageForConstraint(d,this.constraints[e],h);var a=f.src;var c=new mxRectangle(Math.round(h.x-f.width/2),Math.round(h.y-f.height/2),f.width,f.height);var k=new mxImageShape(c,a);k.dialect=(this.graph.dialect!=mxConstants.DIALECT_SVG)?mxConstants.DIALECT_MIXEDHTML:mxConstants.DIALECT_SVG;k.preserveImageAspect=false;k.init(this.graph.getView().getDecoratorPane());if(mxClient.IS_QUIRKS||document.documentMode==8){mxEvent.addListener(k.node,"dragstart",function(i){mxEvent.consume(i);return false})}if(k.node.previousSibling!=null){k.node.parentNode.insertBefore(k.node,k.node.parentNode.firstChild)}var g=mxUtils.bind(this,function(){return(this.currentFocus!=null)?this.currentFocus:d});k.redraw();mxEvent.redirectMouseEvents(k.node,this.graph,g);this.currentFocusArea.add(k.bounds);this.focusIcons.push(k);this.focusPoints.push(h)}this.currentFocusArea.grow(this.getTolerance(j))}else{this.destroyIcons();this.destroyFocusHighlight()}};mxConstraintHandler.prototype.createHighlightShape=function(){var a=new mxRectangleShape(null,this.highlightColor,this.highlightColor,mxConstants.HIGHLIGHT_STROKEWIDTH);a.opacity=mxConstants.HIGHLIGHT_OPACITY;return a};mxConstraintHandler.prototype.intersects=function(c,a,d,b){return mxUtils.intersects(c.bounds,a)};mxConstraintHandler.prototype.destroy=function(){this.reset();if(this.resetHandler!=null){this.graph.model.removeListener(this.resetHandler);this.graph.view.removeListener(this.resetHandler);this.graph.removeListener(this.resetHandler);this.resetHandler=null}if(this.mouseleaveHandler!=null&&this.graph.container!=null){mxEvent.removeListener(this.graph.container,"mouseleave",this.mouseleaveHandler);this.mouseleaveHandler=null}};