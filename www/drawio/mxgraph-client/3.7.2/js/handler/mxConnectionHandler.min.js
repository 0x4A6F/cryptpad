function mxConnectionHandler(b,a){mxEventSource.call(this);if(b!=null){this.graph=b;this.factoryMethod=a;this.init();this.escapeHandler=mxUtils.bind(this,function(d,c){this.reset()});this.graph.addListener(mxEvent.ESCAPE,this.escapeHandler)}}mxUtils.extend(mxConnectionHandler,mxEventSource);mxConnectionHandler.prototype.graph=null;mxConnectionHandler.prototype.factoryMethod=true;mxConnectionHandler.prototype.moveIconFront=false;mxConnectionHandler.prototype.moveIconBack=false;mxConnectionHandler.prototype.connectImage=null;mxConnectionHandler.prototype.targetConnectImage=false;mxConnectionHandler.prototype.enabled=true;mxConnectionHandler.prototype.select=true;mxConnectionHandler.prototype.createTarget=false;mxConnectionHandler.prototype.marker=null;mxConnectionHandler.prototype.constraintHandler=null;mxConnectionHandler.prototype.error=null;mxConnectionHandler.prototype.waypointsEnabled=false;mxConnectionHandler.prototype.ignoreMouseDown=false;mxConnectionHandler.prototype.first=null;mxConnectionHandler.prototype.connectIconOffset=new mxPoint(0,mxConstants.TOOLTIP_VERTICAL_OFFSET);mxConnectionHandler.prototype.edgeState=null;mxConnectionHandler.prototype.changeHandler=null;mxConnectionHandler.prototype.drillHandler=null;mxConnectionHandler.prototype.mouseDownCounter=0;mxConnectionHandler.prototype.movePreviewAway=mxClient.IS_VML;mxConnectionHandler.prototype.outlineConnect=false;mxConnectionHandler.prototype.livePreview=false;mxConnectionHandler.prototype.cursor=null;mxConnectionHandler.prototype.insertBeforeSource=false;mxConnectionHandler.prototype.isEnabled=function(){return this.enabled};mxConnectionHandler.prototype.setEnabled=function(a){this.enabled=a};mxConnectionHandler.prototype.isInsertBefore=function(b,c,d,a,e){return this.insertBeforeSource&&c!=d};mxConnectionHandler.prototype.isCreateTarget=function(a){return this.createTarget};mxConnectionHandler.prototype.setCreateTarget=function(a){this.createTarget=a};mxConnectionHandler.prototype.createShape=function(){var a=(this.livePreview&&this.edgeState!=null)?this.graph.cellRenderer.createShape(this.edgeState):new mxPolyline([],mxConstants.INVALID_COLOR);a.dialect=(this.graph.dialect!=mxConstants.DIALECT_SVG)?mxConstants.DIALECT_VML:mxConstants.DIALECT_SVG;a.scale=this.graph.view.scale;a.pointerEvents=false;a.isDashed=true;a.init(this.graph.getView().getOverlayPane());mxEvent.redirectMouseEvents(a.node,this.graph,null);return a};mxConnectionHandler.prototype.init=function(){this.graph.addMouseListener(this);this.marker=this.createMarker();this.constraintHandler=new mxConstraintHandler(this.graph);this.changeHandler=mxUtils.bind(this,function(a){if(this.iconState!=null){this.iconState=this.graph.getView().getState(this.iconState.cell)}if(this.iconState!=null){this.redrawIcons(this.icons,this.iconState);this.constraintHandler.reset()}else{if(this.previous!=null&&this.graph.view.getState(this.previous.cell)==null){this.reset()}}});this.graph.getModel().addListener(mxEvent.CHANGE,this.changeHandler);this.graph.getView().addListener(mxEvent.SCALE,this.changeHandler);this.graph.getView().addListener(mxEvent.TRANSLATE,this.changeHandler);this.graph.getView().addListener(mxEvent.SCALE_AND_TRANSLATE,this.changeHandler);this.drillHandler=mxUtils.bind(this,function(a){this.reset()});this.graph.addListener(mxEvent.START_EDITING,this.drillHandler);this.graph.getView().addListener(mxEvent.DOWN,this.drillHandler);this.graph.getView().addListener(mxEvent.UP,this.drillHandler)};mxConnectionHandler.prototype.isConnectableCell=function(a){return true};mxConnectionHandler.prototype.createMarker=function(){var a=new mxCellMarker(this.graph);a.hotspotEnabled=true;a.getCell=mxUtils.bind(this,function(d){var b=mxCellMarker.prototype.getCell.apply(a,arguments);this.error=null;if(b==null&&this.currentPoint!=null){b=this.graph.getCellAt(this.currentPoint.x,this.currentPoint.y)}if(b!=null&&!this.graph.isCellConnectable(b)){var c=this.graph.getModel().getParent(b);if(this.graph.getModel().isVertex(c)&&this.graph.isCellConnectable(c)){b=c}}if((this.graph.isSwimlane(b)&&this.currentPoint!=null&&this.graph.hitsSwimlaneContent(b,this.currentPoint.x,this.currentPoint.y))||!this.isConnectableCell(b)){b=null}if(b!=null){if(this.isConnecting()){if(this.previous!=null){this.error=this.validateConnection(this.previous.cell,b);if(this.error!=null&&this.error.length==0){b=null;if(this.isCreateTarget(d.getEvent())){this.error=null}}}}else{if(!this.isValidSource(b,d)){b=null}}}else{if(this.isConnecting()&&!this.isCreateTarget(d.getEvent())&&!this.graph.allowDanglingEdges){this.error=""}}return b});a.isValidState=mxUtils.bind(this,function(b){if(this.isConnecting()){return this.error==null}else{return mxCellMarker.prototype.isValidState.apply(a,arguments)}});a.getMarkerColor=mxUtils.bind(this,function(b,c,d){return(this.connectImage==null||this.isConnecting())?mxCellMarker.prototype.getMarkerColor.apply(a,arguments):null});a.intersects=mxUtils.bind(this,function(c,b){if(this.connectImage!=null||this.isConnecting()){return true}return mxCellMarker.prototype.intersects.apply(a,arguments)});return a};mxConnectionHandler.prototype.start=function(c,b,d,a){this.previous=c;this.first=new mxPoint(b,d);this.edgeState=(a!=null)?a:this.createEdgeState(null);this.marker.currentColor=this.marker.validColor;this.marker.markedState=c;this.marker.mark();this.fireEvent(new mxEventObject(mxEvent.START,"state",this.previous))};mxConnectionHandler.prototype.isConnecting=function(){return this.first!=null&&this.shape!=null};mxConnectionHandler.prototype.isValidSource=function(a,b){return this.graph.isValidSource(a)};mxConnectionHandler.prototype.isValidTarget=function(a){return true};mxConnectionHandler.prototype.validateConnection=function(a,b){if(!this.isValidTarget(b)){return""}return this.graph.getEdgeValidationError(null,a,b)};mxConnectionHandler.prototype.getConnectImage=function(a){return this.connectImage};mxConnectionHandler.prototype.isMoveIconToFrontForState=function(a){if(a.text!=null&&a.text.node.parentNode==this.graph.container){return true}return this.moveIconFront};mxConnectionHandler.prototype.createIcons=function(f){var g=this.getConnectImage(f);if(g!=null&&f!=null){this.iconState=f;var c=[];var e=new mxRectangle(0,0,g.width,g.height);var d=new mxImageShape(e,g.src,null,null,0);d.preserveImageAspect=false;if(this.isMoveIconToFrontForState(f)){d.dialect=mxConstants.DIALECT_STRICTHTML;d.init(this.graph.container)}else{d.dialect=(this.graph.dialect==mxConstants.DIALECT_SVG)?mxConstants.DIALECT_SVG:mxConstants.DIALECT_VML;d.init(this.graph.getView().getOverlayPane());if(this.moveIconBack&&d.node.previousSibling!=null){d.node.parentNode.insertBefore(d.node,d.node.parentNode.firstChild)}}d.node.style.cursor=mxConstants.CURSOR_CONNECT;var b=mxUtils.bind(this,function(){return(this.currentState!=null)?this.currentState:f});var a=mxUtils.bind(this,function(h){if(!mxEvent.isConsumed(h)){this.icon=d;this.graph.fireMouseEvent(mxEvent.MOUSE_DOWN,new mxMouseEvent(h,b()))}});mxEvent.redirectMouseEvents(d.node,this.graph,b,a);c.push(d);this.redrawIcons(c,this.iconState);return c}return null};mxConnectionHandler.prototype.redrawIcons=function(a,b){if(a!=null&&a[0]!=null&&b!=null){var c=this.getIconPosition(a[0],b);a[0].bounds.x=c.x;a[0].bounds.y=c.y;a[0].redraw()}};mxConnectionHandler.prototype.getIconPosition=function(h,a){var c=this.graph.getView().scale;var e=a.getCenterX();var b=a.getCenterY();if(this.graph.isSwimlane(a.cell)){var k=this.graph.getStartSize(a.cell);e=(k.width!=0)?a.x+k.width*c/2:e;b=(k.height!=0)?a.y+k.height*c/2:b;var d=mxUtils.toRadians(mxUtils.getValue(a.style,mxConstants.STYLE_ROTATION)||0);if(d!=0){var i=Math.cos(d);var g=Math.sin(d);var f=new mxPoint(a.getCenterX(),a.getCenterY());var j=mxUtils.getRotatedPoint(new mxPoint(e,b),i,g,f);e=j.x;b=j.y}}return new mxPoint(e-h.bounds.width/2,b-h.bounds.height/2)};mxConnectionHandler.prototype.destroyIcons=function(){if(this.icons!=null){for(var a=0;a<this.icons.length;a++){this.icons[a].destroy()}this.icons=null;this.icon=null;this.selectedIcon=null;this.iconState=null}};mxConnectionHandler.prototype.isStartEvent=function(a){return((this.constraintHandler.currentFocus!=null&&this.constraintHandler.currentConstraint!=null)||(this.previous!=null&&this.error==null&&(this.icons==null||(this.icons!=null&&this.icon!=null))))};mxConnectionHandler.prototype.mouseDown=function(a,b){this.mouseDownCounter++;if(this.isEnabled()&&this.graph.isEnabled()&&!b.isConsumed()&&!this.isConnecting()&&this.isStartEvent(b)){if(this.constraintHandler.currentConstraint!=null&&this.constraintHandler.currentFocus!=null&&this.constraintHandler.currentPoint!=null){this.sourceConstraint=this.constraintHandler.currentConstraint;this.previous=this.constraintHandler.currentFocus;this.first=this.constraintHandler.currentPoint.clone()}else{this.first=new mxPoint(b.getGraphX(),b.getGraphY())}this.edgeState=this.createEdgeState(b);this.mouseDownCounter=1;if(this.waypointsEnabled&&this.shape==null){this.waypoints=null;this.shape=this.createShape();if(this.edgeState!=null){this.shape.apply(this.edgeState)}}if(this.previous==null&&this.edgeState!=null){var c=this.graph.getPointForEvent(b.getEvent());this.edgeState.cell.geometry.setTerminalPoint(c,true)}this.fireEvent(new mxEventObject(mxEvent.START,"state",this.previous));b.consume()}this.selectedIcon=this.icon;this.icon=null};mxConnectionHandler.prototype.isImmediateConnectSource=function(a){return !this.graph.isCellMovable(a.cell)};mxConnectionHandler.prototype.createEdgeState=function(a){return null};mxConnectionHandler.prototype.isOutlineConnectEvent=function(g){var d=mxUtils.getOffset(this.graph.container);var j=g.getEvent();var b=mxEvent.getClientX(j);var a=mxEvent.getClientY(j);var i=document.documentElement;var c=(window.pageXOffset||i.scrollLeft)-(i.clientLeft||0);var h=(window.pageYOffset||i.scrollTop)-(i.clientTop||0);var f=this.currentPoint.x-this.graph.container.scrollLeft+d.x-c;var e=this.currentPoint.y-this.graph.container.scrollTop+d.y-h;return this.outlineConnect&&!mxEvent.isShiftDown(g.getEvent())&&(g.isSource(this.marker.highlight.shape)||(mxEvent.isAltDown(g.getEvent())&&g.getState()!=null)||this.marker.highlight.isHighlightAt(b,a)||((f!=b||e!=a)&&g.getState()==null&&this.marker.highlight.isHighlightAt(f,e)))};mxConnectionHandler.prototype.updateCurrentState=function(d,a){this.constraintHandler.update(d,this.first==null,false,(this.first==null||d.isSource(this.marker.highlight.shape))?null:a);if(this.constraintHandler.currentFocus!=null&&this.constraintHandler.currentConstraint!=null){if(this.marker.highlight!=null&&this.marker.highlight.state!=null&&this.marker.highlight.state.cell==this.constraintHandler.currentFocus.cell){if(this.marker.highlight.shape.stroke!="transparent"){this.marker.highlight.shape.stroke="transparent";this.marker.highlight.repaint()}}else{this.marker.markCell(this.constraintHandler.currentFocus.cell,"transparent")}if(this.previous!=null){this.error=this.validateConnection(this.previous.cell,this.constraintHandler.currentFocus.cell);if(this.error==null){this.currentState=this.constraintHandler.currentFocus}else{this.constraintHandler.reset()}}}else{if(this.graph.isIgnoreTerminalEvent(d.getEvent())){this.marker.reset();this.currentState=null}else{this.marker.process(d);this.currentState=this.marker.getValidState()}var c=this.isOutlineConnectEvent(d);if(this.currentState!=null&&c){if(d.isSource(this.marker.highlight.shape)){a=new mxPoint(d.getGraphX(),d.getGraphY())}var e=this.graph.getOutlineConstraint(a,this.currentState,d);this.constraintHandler.setFocus(d,this.currentState,false);this.constraintHandler.currentConstraint=e;this.constraintHandler.currentPoint=a}if(this.outlineConnect){if(this.marker.highlight!=null&&this.marker.highlight.shape!=null){var b=this.graph.view.scale;if(this.constraintHandler.currentConstraint!=null&&this.constraintHandler.currentFocus!=null){this.marker.highlight.shape.stroke=mxConstants.OUTLINE_HIGHLIGHT_COLOR;this.marker.highlight.shape.strokewidth=mxConstants.OUTLINE_HIGHLIGHT_STROKEWIDTH/b/b;this.marker.highlight.repaint()}else{if(this.marker.hasValidState()){if(this.marker.getValidState()!=d.getState()){this.marker.highlight.shape.stroke="transparent";this.currentState=null}else{this.marker.highlight.shape.stroke=mxConstants.DEFAULT_VALID_COLOR}this.marker.highlight.shape.strokewidth=mxConstants.HIGHLIGHT_STROKEWIDTH/b/b;this.marker.highlight.repaint()}}}}}};mxConnectionHandler.prototype.convertWaypoint=function(a){var c=this.graph.getView().getScale();var b=this.graph.getView().getTranslate();a.x=a.x/c-b.x;a.y=a.y/c-b.y};mxConnectionHandler.prototype.snapToPreview=function(d,a){if(!mxEvent.isAltDown(d.getEvent())&&this.previous!=null){var b=this.graph.gridSize*this.graph.view.scale/2;var c=(this.sourceConstraint!=null)?this.first:new mxPoint(this.previous.getCenterX(),this.previous.getCenterY());if(Math.abs(c.x-d.getGraphX())<b){a.x=c.x}if(Math.abs(c.y-d.getGraphY())<b){a.y=c.y}}};mxConnectionHandler.prototype.mouseMove=function(c,v){if(!v.isConsumed()&&(this.ignoreMouseDown||this.first!=null||!this.graph.isMouseDown)){if(!this.isEnabled()&&this.currentState!=null){this.destroyIcons();this.currentState=null}var m=this.graph.getView();var y=m.scale;var b=m.translate;var q=new mxPoint(v.getGraphX(),v.getGraphY());this.error=null;if(this.graph.isGridEnabledEvent(v.getEvent())){q=new mxPoint((this.graph.snap(q.x/y-b.x)+b.x)*y,(this.graph.snap(q.y/y-b.y)+b.y)*y)}this.snapToPreview(v,q);this.currentPoint=q;if(this.first!=null||(this.isEnabled()&&this.graph.isEnabled())){this.updateCurrentState(v,q)}if(this.first!=null){var a=null;var p=q;if(this.constraintHandler.currentConstraint!=null&&this.constraintHandler.currentFocus!=null&&this.constraintHandler.currentPoint!=null){a=this.constraintHandler.currentConstraint;p=this.constraintHandler.currentPoint.clone()}else{if(this.previous!=null&&!this.graph.isIgnoreTerminalEvent(v.getEvent())&&mxEvent.isShiftDown(v.getEvent())){if(Math.abs(this.previous.getCenterX()-q.x)<Math.abs(this.previous.getCenterY()-q.y)){q.x=this.previous.getCenterX()}else{q.y=this.previous.getCenterY()}}}var f=this.first;if(this.selectedIcon!=null){var k=this.selectedIcon.bounds.width;var t=this.selectedIcon.bounds.height;if(this.currentState!=null&&this.targetConnectImage){var d=this.getIconPosition(this.selectedIcon,this.currentState);this.selectedIcon.bounds.x=d.x;this.selectedIcon.bounds.y=d.y}else{var e=new mxRectangle(v.getGraphX()+this.connectIconOffset.x,v.getGraphY()+this.connectIconOffset.y,k,t);this.selectedIcon.bounds=e}this.selectedIcon.redraw()}if(this.edgeState!=null){this.updateEdgeState(p,a);p=this.edgeState.absolutePoints[this.edgeState.absolutePoints.length-1];f=this.edgeState.absolutePoints[0]}else{if(this.currentState!=null){if(this.constraintHandler.currentConstraint==null){var u=this.getTargetPerimeterPoint(this.currentState,v);if(u!=null){p=u}}}if(this.sourceConstraint==null&&this.previous!=null){var n=(this.waypoints!=null&&this.waypoints.length>0)?this.waypoints[0]:p;var u=this.getSourcePerimeterPoint(this.previous,n,v);if(u!=null){f=u}}}if(this.currentState==null&&this.movePreviewAway){var u=f;if(this.edgeState!=null&&this.edgeState.absolutePoints.length>=2){var o=this.edgeState.absolutePoints[this.edgeState.absolutePoints.length-2];if(o!=null){u=o}}var l=p.x-u.x;var j=p.y-u.y;var s=Math.sqrt(l*l+j*j);if(s==0){return}this.originalPoint=p.clone();p.x-=l*4/s;p.y-=j*4/s}else{this.originalPoint=null}if(this.shape==null){var l=Math.abs(q.x-this.first.x);var j=Math.abs(q.y-this.first.y);if(l>this.graph.tolerance||j>this.graph.tolerance){this.shape=this.createShape();if(this.edgeState!=null){this.shape.apply(this.edgeState)}this.updateCurrentState(v,q)}}if(this.shape!=null){if(this.edgeState!=null){this.shape.points=this.edgeState.absolutePoints}else{var z=[f];if(this.waypoints!=null){z=z.concat(this.waypoints)}z.push(p);this.shape.points=z}this.drawPreview()}if(this.cursor!=null){this.graph.container.style.cursor=this.cursor}mxEvent.consume(v.getEvent());v.consume()}else{if(!this.isEnabled()||!this.graph.isEnabled()){this.constraintHandler.reset()}else{if(this.previous!=this.currentState&&this.edgeState==null){this.destroyIcons();if(this.currentState!=null&&this.error==null&&this.constraintHandler.currentConstraint==null){this.icons=this.createIcons(this.currentState);if(this.icons==null){this.currentState.setCursor(mxConstants.CURSOR_CONNECT);v.consume()}}this.previous=this.currentState}else{if(this.previous==this.currentState&&this.currentState!=null&&this.icons==null&&!this.graph.isMouseDown){v.consume()}}}}if(!this.graph.isMouseDown&&this.currentState!=null&&this.icons!=null){var g=false;var x=v.getSource();for(var r=0;r<this.icons.length&&!g;r++){g=x==this.icons[r].node||x.parentNode==this.icons[r].node}if(!g){this.updateIcons(this.currentState,this.icons,v)}}}else{this.constraintHandler.reset()}};mxConnectionHandler.prototype.updateEdgeState=function(e,d){if(this.sourceConstraint!=null&&this.sourceConstraint.point!=null){this.edgeState.style[mxConstants.STYLE_EXIT_X]=this.sourceConstraint.point.x;this.edgeState.style[mxConstants.STYLE_EXIT_Y]=this.sourceConstraint.point.y}if(d!=null&&d.point!=null){this.edgeState.style[mxConstants.STYLE_ENTRY_X]=d.point.x;this.edgeState.style[mxConstants.STYLE_ENTRY_Y]=d.point.y}else{delete this.edgeState.style[mxConstants.STYLE_ENTRY_X];delete this.edgeState.style[mxConstants.STYLE_ENTRY_Y]}this.edgeState.absolutePoints=[null,(this.currentState!=null)?null:e];this.graph.view.updateFixedTerminalPoint(this.edgeState,this.previous,true,this.sourceConstraint);if(this.currentState!=null){if(d==null){d=this.graph.getConnectionConstraint(this.edgeState,this.previous,false)}this.edgeState.setAbsoluteTerminalPoint(null,false);this.graph.view.updateFixedTerminalPoint(this.edgeState,this.currentState,false,d)}var a=null;if(this.waypoints!=null){a=[];for(var b=0;b<this.waypoints.length;b++){var c=this.waypoints[b].clone();this.convertWaypoint(c);a[b]=c}}this.graph.view.updatePoints(this.edgeState,a,this.previous,this.currentState);this.graph.view.updateFloatingTerminalPoints(this.edgeState,this.previous,this.currentState)};mxConnectionHandler.prototype.getTargetPerimeterPoint=function(g,f){var a=null;var b=g.view;var e=b.getPerimeterFunction(g);if(e!=null){var d=(this.waypoints!=null&&this.waypoints.length>0)?this.waypoints[this.waypoints.length-1]:new mxPoint(this.previous.getCenterX(),this.previous.getCenterY());var c=e(b.getPerimeterBounds(g),this.edgeState,d,false);if(c!=null){a=c}}else{a=new mxPoint(g.getCenterX(),g.getCenterY())}return a};mxConnectionHandler.prototype.getSourcePerimeterPoint=function(a,f,i){var k=null;var j=a.view;var d=j.getPerimeterFunction(a);var h=new mxPoint(a.getCenterX(),a.getCenterY());if(d!=null){var b=mxUtils.getValue(a.style,mxConstants.STYLE_ROTATION,0);var g=-b*(Math.PI/180);if(b!=0){f=mxUtils.getRotatedPoint(new mxPoint(f.x,f.y),Math.cos(g),Math.sin(g),h)}var e=d(j.getPerimeterBounds(a),a,f,false);if(e!=null){if(b!=0){e=mxUtils.getRotatedPoint(new mxPoint(e.x,e.y),Math.cos(-g),Math.sin(-g),h)}k=e}}else{k=h}return k};mxConnectionHandler.prototype.updateIcons=function(c,a,b){};mxConnectionHandler.prototype.isStopEvent=function(a){return a.getState()!=null};mxConnectionHandler.prototype.addWaypointForEvent=function(e){var b=mxUtils.convertPoint(this.graph.container,e.getX(),e.getY());var d=Math.abs(b.x-this.first.x);var c=Math.abs(b.y-this.first.y);var a=this.waypoints!=null||(this.mouseDownCounter>1&&(d>this.graph.tolerance||c>this.graph.tolerance));if(a){if(this.waypoints==null){this.waypoints=[]}var f=this.graph.view.scale;var b=new mxPoint(this.graph.snap(e.getGraphX()/f)*f,this.graph.snap(e.getGraphY()/f)*f);this.waypoints.push(b)}};mxConnectionHandler.prototype.mouseUp=function(a,b){if(!b.isConsumed()&&this.isConnecting()){if(this.waypointsEnabled&&!this.isStopEvent(b)){this.addWaypointForEvent(b);b.consume();return}if(this.error==null){var c=(this.previous!=null)?this.previous.cell:null;var d=null;if(this.constraintHandler.currentConstraint!=null&&this.constraintHandler.currentFocus!=null){d=this.constraintHandler.currentFocus.cell}if(d==null&&this.currentState!=null){d=this.currentState.cell}this.connect(c,d,b.getEvent(),b.getCell())}else{if(this.previous!=null&&this.marker.validState!=null&&this.previous.cell==this.marker.validState.cell){this.graph.selectCellForEvent(this.marker.source,evt)}if(this.error.length>0){this.graph.validationAlert(this.error)}}this.destroyIcons();b.consume()}if(this.first!=null){this.reset()}};mxConnectionHandler.prototype.reset=function(){if(this.shape!=null){this.shape.destroy();this.shape=null}if(this.cursor!=null&&this.graph.container!=null){this.graph.container.style.cursor=""}this.destroyIcons();this.marker.reset();this.constraintHandler.reset();this.originalPoint=null;this.currentPoint=null;this.edgeState=null;this.previous=null;this.error=null;this.sourceConstraint=null;this.mouseDownCounter=0;this.first=null;this.fireEvent(new mxEventObject(mxEvent.RESET))};mxConnectionHandler.prototype.drawPreview=function(){this.updatePreview(this.error==null);this.shape.redraw()};mxConnectionHandler.prototype.updatePreview=function(a){this.shape.strokewidth=this.getEdgeWidth(a);this.shape.stroke=this.getEdgeColor(a)};mxConnectionHandler.prototype.getEdgeColor=function(a){return(a)?mxConstants.VALID_COLOR:mxConstants.INVALID_COLOR};mxConnectionHandler.prototype.getEdgeWidth=function(a){return(a)?3:1};mxConnectionHandler.prototype.connect=function(m,v,k,r){if(v!=null||this.isCreateTarget(k)||this.graph.allowDanglingEdges){var b=this.graph.getModel();var g=false;var c=null;b.beginUpdate();try{if(m!=null&&v==null&&!this.graph.isIgnoreTerminalEvent(k)&&this.isCreateTarget(k)){v=this.createTargetVertex(k,m);if(v!=null){r=this.graph.getDropTarget([v],k,r);g=true;if(r==null||!this.graph.getModel().isEdge(r)){var w=this.graph.getView().getState(r);if(w!=null){var u=b.getGeometry(v);u.x-=w.origin.x;u.y-=w.origin.y}}else{r=this.graph.getDefaultParent()}this.graph.addCell(v,r)}}var f=this.graph.getDefaultParent();if(m!=null&&v!=null&&b.getParent(m)==b.getParent(v)&&b.getParent(b.getParent(m))!=b.getRoot()){f=b.getParent(m);if((m.geometry!=null&&m.geometry.relative)&&(v.geometry!=null&&v.geometry.relative)){f=b.getParent(f)}}var n=null;var p=null;if(this.edgeState!=null){n=this.edgeState.cell.value;p=this.edgeState.cell.style}c=this.insertEdge(f,null,n,m,v,p);if(c!=null){this.graph.setConnectionConstraint(c,m,true,this.sourceConstraint);this.graph.setConnectionConstraint(c,v,false,this.constraintHandler.currentConstraint);if(this.edgeState!=null){b.setGeometry(c,this.edgeState.cell.geometry)}var f=b.getParent(m);if(this.isInsertBefore(c,m,v,k,r)){var d=null;var u=m;while(u.parent!=null&&u.geometry!=null&&u.geometry.relative&&u.parent!=c.parent){u=this.graph.model.getParent(u)}if(u!=null&&u.parent!=null&&u.parent==c.parent){var d=u.parent.getIndex(u);u.parent.insert(c,d)}}var x=b.getGeometry(c);if(x==null){x=new mxGeometry();x.relative=true;b.setGeometry(c,x)}if(this.waypoints!=null&&this.waypoints.length>0){var j=this.graph.view.scale;var a=this.graph.view.translate;x.points=[];for(var o=0;o<this.waypoints.length;o++){var l=this.waypoints[o];x.points.push(new mxPoint(l.x/j-a.x,l.y/j-a.y))}}if(v==null){var h=this.graph.view.translate;var j=this.graph.view.scale;var l=(this.originalPoint!=null)?new mxPoint(this.originalPoint.x/j-h.x,this.originalPoint.y/j-h.y):new mxPoint(this.currentPoint.x/j-h.x,this.currentPoint.y/j-h.y);l.x-=this.graph.panDx/this.graph.view.scale;l.y-=this.graph.panDy/this.graph.view.scale;x.setTerminalPoint(l,false)}this.fireEvent(new mxEventObject(mxEvent.CONNECT,"cell",c,"terminal",v,"event",k,"target",r,"terminalInserted",g))}}catch(q){mxLog.show();mxLog.debug(q.message)}finally{b.endUpdate()}if(this.select){this.selectCells(c,(g)?v:null)}}};mxConnectionHandler.prototype.selectCells=function(a,b){this.graph.setSelectionCell(a)};mxConnectionHandler.prototype.insertEdge=function(b,g,e,d,f,a){if(this.factoryMethod==null){return this.graph.insertEdge(b,g,e,d,f,a)}else{var c=this.createEdge(e,d,f,a);c=this.graph.addEdge(c,b,d,f);return c}};mxConnectionHandler.prototype.createTargetVertex=function(h,a){var c=this.graph.getCellGeometry(a);while(c!=null&&c.relative){a=this.graph.getModel().getParent(a);c=this.graph.getCellGeometry(a)}var d=this.graph.cloneCells([a])[0];var c=this.graph.getModel().getGeometry(d);if(c!=null){var j=this.graph.view.translate;var k=this.graph.view.scale;var g=new mxPoint(this.currentPoint.x/k-j.x,this.currentPoint.y/k-j.y);c.x=Math.round(g.x-c.width/2-this.graph.panDx/k);c.y=Math.round(g.y-c.height/2-this.graph.panDy/k);var i=this.getAlignmentTolerance();if(i>0){var b=this.graph.view.getState(a);if(b!=null){var f=b.x/k-j.x;var e=b.y/k-j.y;if(Math.abs(f-c.x)<=i){c.x=Math.round(f)}if(Math.abs(e-c.y)<=i){c.y=Math.round(e)}}}}return d};mxConnectionHandler.prototype.getAlignmentTolerance=function(a){return(this.graph.isGridEnabled())?this.graph.gridSize/2:this.graph.tolerance};mxConnectionHandler.prototype.createEdge=function(d,c,f,a){var b=null;if(this.factoryMethod!=null){b=this.factoryMethod(c,f,a)}if(b==null){b=new mxCell(d||"");b.setEdge(true);b.setStyle(a);var e=new mxGeometry();e.relative=true;b.setGeometry(e)}return b};mxConnectionHandler.prototype.destroy=function(){this.graph.removeMouseListener(this);if(this.shape!=null){this.shape.destroy();this.shape=null}if(this.marker!=null){this.marker.destroy();this.marker=null}if(this.constraintHandler!=null){this.constraintHandler.destroy();this.constraintHandler=null}if(this.changeHandler!=null){this.graph.getModel().removeListener(this.changeHandler);this.graph.getView().removeListener(this.changeHandler);this.changeHandler=null}if(this.drillHandler!=null){this.graph.removeListener(this.drillHandler);this.graph.getView().removeListener(this.drillHandler);this.drillHandler=null}if(this.escapeHandler!=null){this.graph.removeListener(this.escapeHandler);this.escapeHandler=null}};