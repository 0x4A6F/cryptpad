function mxEdgeHandler(a){if(a!=null){this.state=a;this.init();this.escapeHandler=mxUtils.bind(this,function(c,b){this.reset()});this.state.view.graph.addListener(mxEvent.ESCAPE,this.escapeHandler)}}mxEdgeHandler.prototype.graph=null;mxEdgeHandler.prototype.state=null;mxEdgeHandler.prototype.marker=null;mxEdgeHandler.prototype.constraintHandler=null;mxEdgeHandler.prototype.error=null;mxEdgeHandler.prototype.shape=null;mxEdgeHandler.prototype.bends=null;mxEdgeHandler.prototype.labelShape=null;mxEdgeHandler.prototype.cloneEnabled=true;mxEdgeHandler.prototype.addEnabled=false;mxEdgeHandler.prototype.removeEnabled=false;mxEdgeHandler.prototype.dblClickRemoveEnabled=false;mxEdgeHandler.prototype.mergeRemoveEnabled=false;mxEdgeHandler.prototype.straightRemoveEnabled=false;mxEdgeHandler.prototype.virtualBendsEnabled=false;mxEdgeHandler.prototype.virtualBendOpacity=20;mxEdgeHandler.prototype.parentHighlightEnabled=false;mxEdgeHandler.prototype.preferHtml=false;mxEdgeHandler.prototype.allowHandleBoundsCheck=true;mxEdgeHandler.prototype.snapToTerminals=false;mxEdgeHandler.prototype.handleImage=null;mxEdgeHandler.prototype.tolerance=0;mxEdgeHandler.prototype.outlineConnect=false;mxEdgeHandler.prototype.manageLabelHandle=false;mxEdgeHandler.prototype.init=function(){this.graph=this.state.view.graph;this.marker=this.createMarker();this.constraintHandler=new mxConstraintHandler(this.graph);this.points=[];this.abspoints=this.getSelectionPoints(this.state);this.shape=this.createSelectionShape(this.abspoints);this.shape.dialect=(this.graph.dialect!=mxConstants.DIALECT_SVG)?mxConstants.DIALECT_MIXEDHTML:mxConstants.DIALECT_SVG;this.shape.init(this.graph.getView().getOverlayPane());this.shape.pointerEvents=false;this.shape.setCursor(mxConstants.CURSOR_MOVABLE_EDGE);mxEvent.redirectMouseEvents(this.shape.node,this.graph,this.state);this.preferHtml=this.state.text!=null&&this.state.text.node.parentNode==this.graph.container;if(!this.preferHtml){var a=this.state.getVisibleTerminalState(true);if(a!=null){this.preferHtml=a.text!=null&&a.text.node.parentNode==this.graph.container}if(!this.preferHtml){var c=this.state.getVisibleTerminalState(false);if(c!=null){this.preferHtml=c.text!=null&&c.text.node.parentNode==this.graph.container}}}if(this.parentHighlightEnabled){var b=this.graph.model.getParent(this.state.cell);if(this.graph.model.isVertex(b)){var d=this.graph.view.getState(b);if(d!=null){this.parentHighlight=this.createParentHighlightShape(d);this.parentHighlight.dialect=(this.graph.dialect!=mxConstants.DIALECT_SVG)?mxConstants.DIALECT_VML:mxConstants.DIALECT_SVG;this.parentHighlight.pointerEvents=false;this.parentHighlight.rotation=Number(d.style[mxConstants.STYLE_ROTATION]||"0");this.parentHighlight.init(this.graph.getView().getOverlayPane())}}}if(this.graph.getSelectionCount()<mxGraphHandler.prototype.maxCells||mxGraphHandler.prototype.maxCells<=0){this.bends=this.createBends();if(this.isVirtualBendsEnabled()){this.virtualBends=this.createVirtualBends()}}this.label=new mxPoint(this.state.absoluteOffset.x,this.state.absoluteOffset.y);this.labelShape=this.createLabelHandleShape();this.initBend(this.labelShape);this.labelShape.setCursor(mxConstants.CURSOR_LABEL_HANDLE);this.customHandles=this.createCustomHandles();this.redraw()};mxEdgeHandler.prototype.createCustomHandles=function(){return null};mxEdgeHandler.prototype.isVirtualBendsEnabled=function(a){return this.virtualBendsEnabled&&(this.state.style[mxConstants.STYLE_EDGE]==null||this.state.style[mxConstants.STYLE_EDGE]==mxConstants.NONE||this.state.style[mxConstants.STYLE_NOEDGESTYLE]==1)&&mxUtils.getValue(this.state.style,mxConstants.STYLE_SHAPE,null)!="arrow"};mxEdgeHandler.prototype.isAddPointEvent=function(a){return mxEvent.isShiftDown(a)};mxEdgeHandler.prototype.isRemovePointEvent=function(a){return mxEvent.isShiftDown(a)};mxEdgeHandler.prototype.getSelectionPoints=function(a){return a.absolutePoints};mxEdgeHandler.prototype.createParentHighlightShape=function(b){var a=new mxRectangleShape(b,null,this.getSelectionColor());a.strokewidth=this.getSelectionStrokeWidth();a.isDashed=this.isSelectionDashed();return a};mxEdgeHandler.prototype.createSelectionShape=function(b){var a=new this.state.shape.constructor();a.outline=true;a.apply(this.state);a.isDashed=this.isSelectionDashed();a.stroke=this.getSelectionColor();a.isShadow=false;return a};mxEdgeHandler.prototype.getSelectionColor=function(){return mxConstants.EDGE_SELECTION_COLOR};mxEdgeHandler.prototype.getSelectionStrokeWidth=function(){return mxConstants.EDGE_SELECTION_STROKEWIDTH};mxEdgeHandler.prototype.isSelectionDashed=function(){return mxConstants.EDGE_SELECTION_DASHED};mxEdgeHandler.prototype.isConnectableCell=function(a){return true};mxEdgeHandler.prototype.getCellAt=function(a,b){return(!this.outlineConnect)?this.graph.getCellAt(a,b):null};mxEdgeHandler.prototype.createMarker=function(){var a=new mxCellMarker(this.graph);var b=this;a.getCell=function(f){var c=mxCellMarker.prototype.getCell.apply(this,arguments);if((c==b.state.cell||c==null)&&b.currentPoint!=null){c=b.graph.getCellAt(b.currentPoint.x,b.currentPoint.y)}if(c!=null&&!this.graph.isCellConnectable(c)){var e=this.graph.getModel().getParent(c);if(this.graph.getModel().isVertex(e)&&this.graph.isCellConnectable(e)){c=e}}var d=b.graph.getModel();if((this.graph.isSwimlane(c)&&b.currentPoint!=null&&this.graph.hitsSwimlaneContent(c,b.currentPoint.x,b.currentPoint.y))||(!b.isConnectableCell(c))||(c==b.state.cell||(c!=null&&!b.graph.connectableEdges&&d.isEdge(c)))||d.isAncestor(b.state.cell,c)){c=null}if(!this.graph.isCellConnectable(c)){c=null}return c};a.isValidState=function(f){var d=b.graph.getModel();var c=b.graph.view.getTerminalPort(f,b.graph.view.getState(d.getTerminal(b.state.cell,!b.isSource)),!b.isSource);var i=(c!=null)?c.cell:null;var e=(b.isSource)?f.cell:i;var g=(b.isSource)?i:f.cell;b.error=b.validateConnection(e,g);return b.error==null};return a};mxEdgeHandler.prototype.validateConnection=function(a,b){return this.graph.getEdgeValidationError(this.state.cell,a,b)};mxEdgeHandler.prototype.createBends=function(){var a=this.state.cell;var d=[];for(var c=0;c<this.abspoints.length;c++){if(this.isHandleVisible(c)){var e=c==0;var f=c==this.abspoints.length-1;var b=e||f;if(b||this.graph.isCellBendable(a)){(mxUtils.bind(this,function(g){var i=this.createHandleShape(g);this.initBend(i,mxUtils.bind(this,mxUtils.bind(this,function(){if(this.dblClickRemoveEnabled){this.removePoint(this.state,g)}})));if(this.isHandleEnabled(c)){i.setCursor((b)?mxConstants.CURSOR_TERMINAL_HANDLE:mxConstants.CURSOR_BEND_HANDLE)}d.push(i);if(!b){this.points.push(new mxPoint(0,0));i.node.style.visibility="hidden"}}))(c)}}}return d};mxEdgeHandler.prototype.createVirtualBends=function(){var a=this.state.cell;var d=this.abspoints[0];var c=[];if(this.graph.isCellBendable(a)){for(var b=1;b<this.abspoints.length;b++){(mxUtils.bind(this,function(e){this.initBend(e);e.setCursor(mxConstants.CURSOR_VIRTUAL_BEND_HANDLE);c.push(e)}))(this.createHandleShape())}}return c};mxEdgeHandler.prototype.isHandleEnabled=function(a){return true};mxEdgeHandler.prototype.isHandleVisible=function(a){var b=this.state.getVisibleTerminalState(true);var d=this.state.getVisibleTerminalState(false);var c=this.graph.getCellGeometry(this.state.cell);var e=(c!=null)?this.graph.view.getEdgeStyle(this.state,c.points,b,d):null;return e!=mxEdgeStyle.EntityRelation||a==0||a==this.abspoints.length-1};mxEdgeHandler.prototype.createHandleShape=function(b){if(this.handleImage!=null){var a=new mxImageShape(new mxRectangle(0,0,this.handleImage.width,this.handleImage.height),this.handleImage.src);a.preserveImageAspect=false;return a}else{var c=mxConstants.HANDLE_SIZE;if(this.preferHtml){c-=1}return new mxRectangleShape(new mxRectangle(0,0,c,c),mxConstants.HANDLE_FILLCOLOR,mxConstants.HANDLE_STROKECOLOR)}};mxEdgeHandler.prototype.createLabelHandleShape=function(){if(this.labelHandleImage!=null){var a=new mxImageShape(new mxRectangle(0,0,this.labelHandleImage.width,this.labelHandleImage.height),this.labelHandleImage.src);a.preserveImageAspect=false;return a}else{var b=mxConstants.LABEL_HANDLE_SIZE;return new mxRectangleShape(new mxRectangle(0,0,b,b),mxConstants.LABEL_HANDLE_FILLCOLOR,mxConstants.HANDLE_STROKECOLOR)}};mxEdgeHandler.prototype.initBend=function(b,a){if(this.preferHtml){b.dialect=mxConstants.DIALECT_STRICTHTML;b.init(this.graph.container)}else{b.dialect=(this.graph.dialect!=mxConstants.DIALECT_SVG)?mxConstants.DIALECT_MIXEDHTML:mxConstants.DIALECT_SVG;b.init(this.graph.getView().getOverlayPane())}mxEvent.redirectMouseEvents(b.node,this.graph,this.state,null,null,null,a);if(mxClient.IS_QUIRKS||document.documentMode==8){mxEvent.addListener(b.node,"dragstart",function(c){mxEvent.consume(c);return false})}if(mxClient.IS_TOUCH){b.node.setAttribute("pointer-events","none")}};mxEdgeHandler.prototype.getHandleForEvent=function(f){var c=(!mxEvent.isMouseEvent(f.getEvent()))?this.tolerance:1;var g=(this.allowHandleBoundsCheck&&(mxClient.IS_IE||c>0))?new mxRectangle(f.getGraphX()-c,f.getGraphY()-c,2*c,2*c):null;var d=null;var b=null;function a(k){if(k!=null&&k.node.style.display!="none"&&k.node.style.visibility!="hidden"&&(f.isSource(k)||(g!=null&&mxUtils.intersects(k.bounds,g)))){var j=f.getGraphX()-k.bounds.getCenterX();var i=f.getGraphY()-k.bounds.getCenterY();var l=j*j+i*i;if(d==null||l<=d){d=l;return true}}return false}if(this.customHandles!=null&&this.isCustomHandleEvent(f)){for(var e=this.customHandles.length-1;e>=0;e--){if(a(this.customHandles[e].shape)){return mxEvent.CUSTOM_HANDLE-e}}}if(f.isSource(this.state.text)||a(this.labelShape)){b=mxEvent.LABEL_HANDLE}if(this.bends!=null){for(var e=0;e<this.bends.length;e++){if(a(this.bends[e])){b=e}}}if(this.virtualBends!=null&&this.isAddVirtualBendEvent(f)){for(var e=0;e<this.virtualBends.length;e++){if(a(this.virtualBends[e])){b=mxEvent.VIRTUAL_HANDLE-e}}}return b};mxEdgeHandler.prototype.isAddVirtualBendEvent=function(a){return true};mxEdgeHandler.prototype.isCustomHandleEvent=function(a){return true};mxEdgeHandler.prototype.mouseDown=function(c,d){var e=this.getHandleForEvent(d);if(this.bends!=null&&this.bends[e]!=null){var a=this.bends[e].bounds;this.snapPoint=new mxPoint(a.getCenterX(),a.getCenterY())}if(this.addEnabled&&e==null&&this.isAddPointEvent(d.getEvent())){this.addPoint(this.state,d.getEvent());d.consume()}else{if(e!=null&&!d.isConsumed()&&this.graph.isEnabled()){if(this.removeEnabled&&this.isRemovePointEvent(d.getEvent())){this.removePoint(this.state,e)}else{if(e!=mxEvent.LABEL_HANDLE||this.graph.isLabelMovable(d.getCell())){if(e<=mxEvent.VIRTUAL_HANDLE){mxUtils.setOpacity(this.virtualBends[mxEvent.VIRTUAL_HANDLE-e].node,100)}this.start(d.getX(),d.getY(),e)}}d.consume()}}};mxEdgeHandler.prototype.start=function(b,f,c){this.startX=b;this.startY=f;this.isSource=(this.bends==null)?false:c==0;this.isTarget=(this.bends==null)?false:c==this.bends.length-1;this.isLabel=c==mxEvent.LABEL_HANDLE;if(this.isSource||this.isTarget){var a=this.state.cell;var e=this.graph.model.getTerminal(a,this.isSource);if((e==null&&this.graph.isTerminalPointMovable(a,this.isSource))||(e!=null&&this.graph.isCellDisconnectable(a,e,this.isSource))){this.index=c}}else{this.index=c}if(this.index<=mxEvent.CUSTOM_HANDLE&&this.index>mxEvent.VIRTUAL_HANDLE){if(this.customHandles!=null){for(var d=0;d<this.customHandles.length;d++){if(d!=mxEvent.CUSTOM_HANDLE-this.index){this.customHandles[d].setVisible(false)}}}}};mxEdgeHandler.prototype.clonePreviewState=function(a,b){return this.state.clone()};mxEdgeHandler.prototype.getSnapToTerminalTolerance=function(){return this.graph.gridSize*this.graph.view.scale/2};mxEdgeHandler.prototype.updateHint=function(b,a){};mxEdgeHandler.prototype.removeHint=function(){};mxEdgeHandler.prototype.roundLength=function(a){return Math.round(a)};mxEdgeHandler.prototype.isSnapToTerminalsEvent=function(a){return this.snapToTerminals&&!mxEvent.isAltDown(a.getEvent())};mxEdgeHandler.prototype.getPointForEvent=function(j){var k=this.graph.getView();var d=k.scale;var l=new mxPoint(this.roundLength(j.getGraphX()/d)*d,this.roundLength(j.getGraphY()/d)*d);var f=this.getSnapToTerminalTolerance();var b=false;var m=false;if(f>0&&this.isSnapToTerminalsEvent(j)){function c(n){if(n!=null){var i=n.x;if(Math.abs(l.x-i)<f){l.x=i;b=true}var o=n.y;if(Math.abs(l.y-o)<f){l.y=o;m=true}}}function a(i){if(i!=null){c.call(this,new mxPoint(k.getRoutingCenterX(i),k.getRoutingCenterY(i)))}}a.call(this,this.state.getVisibleTerminalState(true));a.call(this,this.state.getVisibleTerminalState(false));if(this.state.absolutePoints!=null){for(var e=0;e<this.state.absolutePoints.length;e++){c.call(this,this.state.absolutePoints[e])}}}if(this.graph.isGridEnabledEvent(j.getEvent())){var g=k.translate;if(!b){l.x=(this.graph.snap(l.x/d-g.x)+g.x)*d}if(!m){l.y=(this.graph.snap(l.y/d-g.y)+g.y)*d}}return l};mxEdgeHandler.prototype.getPreviewTerminalState=function(d){this.constraintHandler.update(d,this.isSource,true,d.isSource(this.marker.highlight.shape)?null:this.currentPoint);if(this.constraintHandler.currentFocus!=null&&this.constraintHandler.currentConstraint!=null){if(this.marker.highlight!=null&&this.marker.highlight.state!=null&&this.marker.highlight.state.cell==this.constraintHandler.currentFocus.cell){if(this.marker.highlight.shape.stroke!="transparent"){this.marker.highlight.shape.stroke="transparent";this.marker.highlight.repaint()}}else{this.marker.markCell(this.constraintHandler.currentFocus.cell,"transparent")}var c=this.graph.getModel();var b=this.graph.view.getTerminalPort(this.state,this.graph.view.getState(c.getTerminal(this.state.cell,!this.isSource)),!this.isSource);var g=(b!=null)?b.cell:null;var e=(this.isSource)?this.constraintHandler.currentFocus.cell:g;var f=(this.isSource)?g:this.constraintHandler.currentFocus.cell;this.error=this.validateConnection(e,f);var a=null;if(this.error==null){a=this.constraintHandler.currentFocus}else{this.constraintHandler.reset()}return a}else{if(!this.graph.isIgnoreTerminalEvent(d.getEvent())){this.marker.process(d);return this.marker.getValidState()}else{this.marker.reset();return null}}};mxEdgeHandler.prototype.getPreviewPoints=function(p,g){var j=this.graph.getCellGeometry(this.state.cell);var m=(j.points!=null)?j.points.slice():null;var l=new mxPoint(p.x,p.y);var q=null;if(!this.isSource&&!this.isTarget){this.convertPoint(l,false);if(m==null){m=[l]}else{if(this.index<=mxEvent.VIRTUAL_HANDLE){m.splice(mxEvent.VIRTUAL_HANDLE-this.index,0,l)}if(!this.isSource&&!this.isTarget){for(var e=0;e<this.bends.length;e++){if(e!=this.index){var k=this.bends[e];if(k!=null&&mxUtils.contains(k.bounds,p.x,p.y)){if(this.index<=mxEvent.VIRTUAL_HANDLE){m.splice(mxEvent.VIRTUAL_HANDLE-this.index,1)}else{m.splice(this.index-1,1)}q=m}}}if(q==null&&this.straightRemoveEnabled&&(g==null||!mxEvent.isAltDown(g.getEvent()))){var n=this.graph.tolerance*this.graph.tolerance;var o=this.state.absolutePoints.slice();o[this.index]=p;var a=this.state.getVisibleTerminalState(true);if(a!=null){var f=this.graph.getConnectionConstraint(this.state,a,true);if(f==null||this.graph.getConnectionPoint(a,f)==null){o[0]=new mxPoint(a.view.getRoutingCenterX(a),a.view.getRoutingCenterY(a))}}var b=this.state.getVisibleTerminalState(false);if(b!=null){var f=this.graph.getConnectionConstraint(this.state,b,false);if(f==null||this.graph.getConnectionPoint(b,f)==null){o[o.length-1]=new mxPoint(b.view.getRoutingCenterX(b),b.view.getRoutingCenterY(b))}}function d(c,i){if(c>0&&c<o.length-1&&mxUtils.ptSegDistSq(o[c-1].x,o[c-1].y,o[c+1].x,o[c+1].y,i.x,i.y)<n){m.splice(c-1,1);q=m}}d(this.index,p)}}if(q==null&&this.index>mxEvent.VIRTUAL_HANDLE){m[this.index-1]=l}}}else{if(this.graph.resetEdgesOnConnect){m=null}}return(q!=null)?q:m};mxEdgeHandler.prototype.isOutlineConnectEvent=function(g){var d=mxUtils.getOffset(this.graph.container);var k=g.getEvent();var b=mxEvent.getClientX(k);var a=mxEvent.getClientY(k);var j=document.documentElement;var c=(window.pageXOffset||j.scrollLeft)-(j.clientLeft||0);var i=(window.pageYOffset||j.scrollTop)-(j.clientTop||0);var f=this.currentPoint.x-this.graph.container.scrollLeft+d.x-c;var e=this.currentPoint.y-this.graph.container.scrollTop+d.y-i;return this.outlineConnect&&!mxEvent.isShiftDown(g.getEvent())&&(g.isSource(this.marker.highlight.shape)||(mxEvent.isAltDown(g.getEvent())&&g.getState()!=null)||this.marker.highlight.isHighlightAt(b,a)||((f!=b||e!=a)&&g.getState()==null&&this.marker.highlight.isHighlightAt(f,e)))};mxEdgeHandler.prototype.updatePreviewState=function(e,k,a,i,b){var c=(this.isSource)?a:this.state.getVisibleTerminalState(true);var j=(this.isTarget)?a:this.state.getVisibleTerminalState(false);var g=this.graph.getConnectionConstraint(e,c,true);var f=this.graph.getConnectionConstraint(e,j,false);var d=this.constraintHandler.currentConstraint;if(d==null&&b){if(a!=null){if(i.isSource(this.marker.highlight.shape)){k=new mxPoint(i.getGraphX(),i.getGraphY())}d=this.graph.getOutlineConstraint(k,a,i);this.constraintHandler.setFocus(i,a,this.isSource);this.constraintHandler.currentConstraint=d;this.constraintHandler.currentPoint=k}else{d=new mxConnectionConstraint()}}if(this.outlineConnect&&this.marker.highlight!=null&&this.marker.highlight.shape!=null){var l=this.graph.view.scale;if(this.constraintHandler.currentConstraint!=null&&this.constraintHandler.currentFocus!=null){this.marker.highlight.shape.stroke=(b)?mxConstants.OUTLINE_HIGHLIGHT_COLOR:"transparent";this.marker.highlight.shape.strokewidth=mxConstants.OUTLINE_HIGHLIGHT_STROKEWIDTH/l/l;this.marker.highlight.repaint()}else{if(this.marker.hasValidState()){this.marker.highlight.shape.stroke=(this.marker.getValidState()==i.getState())?mxConstants.DEFAULT_VALID_COLOR:"transparent";this.marker.highlight.shape.strokewidth=mxConstants.HIGHLIGHT_STROKEWIDTH/l/l;this.marker.highlight.repaint()}}}if(this.isSource){g=d}else{if(this.isTarget){f=d}}if(this.isSource||this.isTarget){if(d!=null&&d.point!=null){e.style[(this.isSource)?mxConstants.STYLE_EXIT_X:mxConstants.STYLE_ENTRY_X]=d.point.x;e.style[(this.isSource)?mxConstants.STYLE_EXIT_Y:mxConstants.STYLE_ENTRY_Y]=d.point.y}else{delete e.style[(this.isSource)?mxConstants.STYLE_EXIT_X:mxConstants.STYLE_ENTRY_X];delete e.style[(this.isSource)?mxConstants.STYLE_EXIT_Y:mxConstants.STYLE_ENTRY_Y]}}e.setVisibleTerminalState(c,true);e.setVisibleTerminalState(j,false);if(!this.isSource||c!=null){e.view.updateFixedTerminalPoint(e,c,true,g)}if(!this.isTarget||j!=null){e.view.updateFixedTerminalPoint(e,j,false,f)}if((this.isSource||this.isTarget)&&a==null){e.setAbsoluteTerminalPoint(k,this.isSource);if(this.marker.getMarkedState()==null){this.error=(this.graph.allowDanglingEdges)?null:""}}e.view.updatePoints(e,this.points,c,j);e.view.updateFloatingTerminalPoints(e,c,j)};mxEdgeHandler.prototype.mouseMove=function(b,e){if(this.index!=null&&this.marker!=null){this.currentPoint=this.getPointForEvent(e);this.error=null;if(!this.graph.isIgnoreTerminalEvent(e.getEvent())&&mxEvent.isShiftDown(e.getEvent())&&this.snapPoint!=null){if(Math.abs(this.snapPoint.x-this.currentPoint.x)<Math.abs(this.snapPoint.y-this.currentPoint.y)){this.currentPoint.x=this.snapPoint.x}else{this.currentPoint.y=this.snapPoint.y}}if(this.index<=mxEvent.CUSTOM_HANDLE&&this.index>mxEvent.VIRTUAL_HANDLE){if(this.customHandles!=null){this.customHandles[mxEvent.CUSTOM_HANDLE-this.index].processEvent(e)}}else{if(this.isLabel){this.label.x=this.currentPoint.x;this.label.y=this.currentPoint.y}else{this.points=this.getPreviewPoints(this.currentPoint,e);var d=(this.isSource||this.isTarget)?this.getPreviewTerminalState(e):null;if(this.constraintHandler.currentConstraint!=null&&this.constraintHandler.currentFocus!=null&&this.constraintHandler.currentPoint!=null){this.currentPoint=this.constraintHandler.currentPoint.clone()}else{if(this.outlineConnect){var c=(this.isSource||this.isTarget)?this.isOutlineConnectEvent(e):false;if(c){d=this.marker.highlight.state}else{if(d!=null&&d!=e.getState()&&this.marker.highlight.shape!=null){this.marker.highlight.shape.stroke="transparent";this.marker.highlight.repaint();d=null}}}}var f=this.clonePreviewState(this.currentPoint,(d!=null)?d.cell:null);this.updatePreviewState(f,this.currentPoint,d,e,c);var a=(this.error==null)?this.marker.validColor:this.marker.invalidColor;this.setPreviewColor(a);this.abspoints=f.absolutePoints;this.active=true}}this.updateHint(e,this.currentPoint);this.drawPreview();mxEvent.consume(e.getEvent());e.consume()}else{if(mxClient.IS_IE&&this.getHandleForEvent(e)!=null){e.consume(false)}}};mxEdgeHandler.prototype.mouseUp=function(c,e){if(this.index!=null&&this.marker!=null){var d=this.state.cell;if(e.getX()!=this.startX||e.getY()!=this.startY){var i=!this.graph.isIgnoreTerminalEvent(e.getEvent())&&this.graph.isCloneEvent(e.getEvent())&&this.cloneEnabled&&this.graph.isCellsCloneable();if(this.error!=null){if(this.error.length>0){this.graph.validationAlert(this.error)}}else{if(this.index<=mxEvent.CUSTOM_HANDLE&&this.index>mxEvent.VIRTUAL_HANDLE){if(this.customHandles!=null){var a=this.graph.getModel();a.beginUpdate();try{this.customHandles[mxEvent.CUSTOM_HANDLE-this.index].execute()}finally{a.endUpdate()}}}else{if(this.isLabel){this.moveLabel(this.state,this.label.x,this.label.y)}else{if(this.isSource||this.isTarget){var b=null;if(this.constraintHandler.currentConstraint!=null&&this.constraintHandler.currentFocus!=null){b=this.constraintHandler.currentFocus.cell}if(b==null&&this.marker.hasValidState()&&this.marker.highlight!=null&&this.marker.highlight.shape!=null&&this.marker.highlight.shape.stroke!="transparent"&&this.marker.highlight.shape.stroke!="white"){b=this.marker.validState.cell}if(b!=null){d=this.connect(d,b,this.isSource,i,e)}else{if(this.graph.isAllowDanglingEdges()){var g=this.abspoints[(this.isSource)?0:this.abspoints.length-1];g.x=this.roundLength(g.x/this.graph.view.scale-this.graph.view.translate.x);g.y=this.roundLength(g.y/this.graph.view.scale-this.graph.view.translate.y);var f=this.graph.getView().getState(this.graph.getModel().getParent(d));if(f!=null){g.x-=f.origin.x;g.y-=f.origin.y}g.x-=this.graph.panDx/this.graph.view.scale;g.y-=this.graph.panDy/this.graph.view.scale;d=this.changeTerminalPoint(d,g,this.isSource,i)}}}else{if(this.active){d=this.changePoints(d,this.points,i)}else{this.graph.getView().invalidate(this.state.cell);this.graph.getView().validate(this.state.cell)}}}}}}if(this.marker!=null){this.reset();if(d!=this.state.cell){this.graph.setSelectionCell(d)}}e.consume()}};mxEdgeHandler.prototype.reset=function(){this.error=null;this.index=null;this.label=null;this.points=null;this.snapPoint=null;this.active=false;this.isLabel=false;this.isSource=false;this.isTarget=false;if(this.livePreview&&this.sizers!=null){for(var a=0;a<this.sizers.length;a++){if(this.sizers[a]!=null){this.sizers[a].node.style.display=""}}}if(this.marker!=null){this.marker.reset()}if(this.constraintHandler!=null){this.constraintHandler.reset()}if(this.customHandles!=null){for(var a=0;a<this.customHandles.length;a++){this.customHandles[a].reset()}}this.setPreviewColor(mxConstants.EDGE_SELECTION_COLOR);this.removeHint();this.redraw()};mxEdgeHandler.prototype.setPreviewColor=function(a){if(this.shape!=null){this.shape.stroke=a}};mxEdgeHandler.prototype.convertPoint=function(a,d){var e=this.graph.getView().getScale();var c=this.graph.getView().getTranslate();if(d){a.x=this.graph.snap(a.x);a.y=this.graph.snap(a.y)}a.x=Math.round(a.x/e-c.x);a.y=Math.round(a.y/e-c.y);var b=this.graph.getView().getState(this.graph.getModel().getParent(this.state.cell));if(b!=null){a.x-=b.origin.x;a.y-=b.origin.y}return a};mxEdgeHandler.prototype.moveLabel=function(e,j,g){var d=this.graph.getModel();var i=d.getGeometry(e.cell);if(i!=null){var b=this.graph.getView().scale;i=i.clone();if(i.relative){var m=this.graph.getView().getRelativePoint(e,j,g);i.x=Math.round(m.x*10000)/10000;i.y=Math.round(m.y);i.offset=new mxPoint(0,0);var m=this.graph.view.getPoint(e,i);i.offset=new mxPoint(Math.round((j-m.x)/b),Math.round((g-m.y)/b))}else{var k=e.absolutePoints;var l=k[0];var f=k[k.length-1];if(l!=null&&f!=null){var c=l.x+(f.x-l.x)/2;var a=l.y+(f.y-l.y)/2;i.offset=new mxPoint(Math.round((j-c)/b),Math.round((g-a)/b));i.x=0;i.y=0}}d.setGeometry(e.cell,i)}};mxEdgeHandler.prototype.connect=function(b,d,g,f,j){var c=this.graph.getModel();var k=c.getParent(b);c.beginUpdate();try{if(f){var i=this.graph.cloneCells([b])[0];c.add(k,i,c.getChildCount(k));var e=c.getTerminal(b,!g);this.graph.connectCell(i,e,!g);b=i}var a=this.constraintHandler.currentConstraint;if(a==null){a=new mxConnectionConstraint()}this.graph.connectCell(b,d,g,a)}finally{c.endUpdate()}return b};mxEdgeHandler.prototype.changeTerminalPoint=function(f,a,d,i){var b=this.graph.getModel();b.beginUpdate();try{if(i){var e=b.getParent(f);var c=b.getTerminal(f,!d);f=this.graph.cloneCells([f])[0];b.add(e,f,b.getChildCount(e));b.setTerminal(f,c,!d)}var g=b.getGeometry(f);if(g!=null){g=g.clone();g.setTerminalPoint(a,d);b.setGeometry(f,g);this.graph.connectCell(f,null,d,new mxConnectionConstraint())}}finally{b.endUpdate()}return f};mxEdgeHandler.prototype.changePoints=function(d,c,i){var a=this.graph.getModel();a.beginUpdate();try{if(i){var b=a.getParent(d);var e=a.getTerminal(d,true);var g=a.getTerminal(d,false);d=this.graph.cloneCells([d])[0];a.add(b,d,a.getChildCount(b));a.setTerminal(d,e,true);a.setTerminal(d,g,false)}var f=a.getGeometry(d);if(f!=null){f=f.clone();f.points=c;a.setGeometry(d,f)}}finally{a.endUpdate()}return d};mxEdgeHandler.prototype.addPoint=function(b,a){var d=mxUtils.convertPoint(this.graph.container,mxEvent.getClientX(a),mxEvent.getClientY(a));var c=this.graph.isGridEnabledEvent(a);this.convertPoint(d,c);this.addPointAt(b,d.x,d.y);mxEvent.consume(a)};mxEdgeHandler.prototype.addPointAt=function(a,g,f){var d=this.graph.getCellGeometry(a.cell);var k=new mxPoint(g,f);if(d!=null){d=d.clone();var j=this.graph.view.translate;var l=this.graph.view.scale;var c=new mxPoint(j.x*l,j.y*l);var i=this.graph.model.getParent(this.state.cell);if(this.graph.model.isVertex(i)){var b=this.graph.view.getState(i);c=new mxPoint(b.x,b.y)}var e=mxUtils.findNearestSegment(a,k.x*l+c.x,k.y*l+c.y);if(d.points==null){d.points=[k]}else{d.points.splice(e,0,k)}this.graph.getModel().setGeometry(a.cell,d);this.refresh();this.redraw()}};mxEdgeHandler.prototype.removePoint=function(b,a){if(a>0&&a<this.abspoints.length-1){var c=this.graph.getCellGeometry(this.state.cell);if(c!=null&&c.points!=null){c=c.clone();c.points.splice(a-1,1);this.graph.getModel().setGeometry(b.cell,c);this.refresh();this.redraw()}}};mxEdgeHandler.prototype.getHandleFillColor=function(c){var e=c==0;var a=this.state.cell;var d=this.graph.getModel().getTerminal(a,e);var b=mxConstants.HANDLE_FILLCOLOR;if((d!=null&&!this.graph.isCellDisconnectable(a,d,e))||(d==null&&!this.graph.isTerminalPointMovable(a,e))){b=mxConstants.LOCKED_HANDLE_FILLCOLOR}else{if(d!=null&&this.graph.isCellDisconnectable(a,d,e)){b=mxConstants.CONNECT_HANDLE_FILLCOLOR}}return b};mxEdgeHandler.prototype.redraw=function(){this.abspoints=this.state.absolutePoints.slice();this.redrawHandles();var b=this.graph.getModel().getGeometry(this.state.cell);var c=b.points;if(this.bends!=null&&this.bends.length>0){if(c!=null){if(this.points==null){this.points=[]}for(var a=1;a<this.bends.length-1;a++){if(this.bends[a]!=null&&this.abspoints[a]!=null){this.points[a-1]=c[a-1]}}}}this.drawPreview()};mxEdgeHandler.prototype.redrawHandles=function(){var r=this.state.cell;var m=this.labelShape.bounds;this.label=new mxPoint(this.state.absoluteOffset.x,this.state.absoluteOffset.y);this.labelShape.bounds=new mxRectangle(Math.round(this.label.x-m.width/2),Math.round(this.label.y-m.height/2),m.width,m.height);var j=this.graph.getLabel(r);this.labelShape.visible=(j!=null&&j.length>0&&this.graph.isLabelMovable(r));if(this.bends!=null&&this.bends.length>0){var e=this.abspoints.length-1;var s=this.abspoints[0];var d=s.x;var p=s.y;m=this.bends[0].bounds;this.bends[0].bounds=new mxRectangle(Math.floor(d-m.width/2),Math.floor(p-m.height/2),m.width,m.height);this.bends[0].fill=this.getHandleFillColor(0);this.bends[0].redraw();if(this.manageLabelHandle){this.checkLabelHandle(this.bends[0].bounds)}var k=this.abspoints[e];var g=k.x;var c=k.y;var a=this.bends.length-1;m=this.bends[a].bounds;this.bends[a].bounds=new mxRectangle(Math.floor(g-m.width/2),Math.floor(c-m.height/2),m.width,m.height);this.bends[a].fill=this.getHandleFillColor(a);this.bends[a].redraw();if(this.manageLabelHandle){this.checkLabelHandle(this.bends[a].bounds)}this.redrawInnerBends(s,k)}if(this.abspoints!=null&&this.virtualBends!=null&&this.virtualBends.length>0){var q=this.abspoints[0];for(var f=0;f<this.virtualBends.length;f++){if(this.virtualBends[f]!=null&&this.abspoints[f+1]!=null){var t=this.abspoints[f+1];var m=this.virtualBends[f];var o=q.x+(t.x-q.x)/2;var l=q.y+(t.y-q.y)/2;m.bounds=new mxRectangle(Math.floor(o-m.bounds.width/2),Math.floor(l-m.bounds.height/2),m.bounds.width,m.bounds.height);m.redraw();mxUtils.setOpacity(m.node,this.virtualBendOpacity);q=t;if(this.manageLabelHandle){this.checkLabelHandle(m.bounds)}}}}if(this.labelShape!=null){this.labelShape.redraw()}if(this.customHandles!=null){for(var f=0;f<this.customHandles.length;f++){this.customHandles[f].redraw()}}};mxEdgeHandler.prototype.setHandlesVisible=function(b){if(this.bends!=null){for(var a=0;a<this.bends.length;a++){this.bends[a].node.style.display=(b)?"":"none"}}if(this.virtualBends!=null){for(var a=0;a<this.virtualBends.length;a++){this.virtualBends[a].node.style.display=(b)?"":"none"}}if(this.labelShape!=null){this.labelShape.node.style.display=(b)?"":"none"}if(this.customHandles!=null){for(var a=0;a<this.customHandles.length;a++){this.customHandles[a].setVisible(b)}}};mxEdgeHandler.prototype.redrawInnerBends=function(g,d){for(var e=1;e<this.bends.length-1;e++){if(this.bends[e]!=null){if(this.abspoints[e]!=null){var c=this.abspoints[e].x;var f=this.abspoints[e].y;var a=this.bends[e].bounds;this.bends[e].node.style.visibility="visible";this.bends[e].bounds=new mxRectangle(Math.round(c-a.width/2),Math.round(f-a.height/2),a.width,a.height);if(this.manageLabelHandle){this.checkLabelHandle(this.bends[e].bounds)}else{if(this.handleImage==null&&this.labelShape.visible&&mxUtils.intersects(this.bends[e].bounds,this.labelShape.bounds)){w=mxConstants.HANDLE_SIZE+3;h=mxConstants.HANDLE_SIZE+3;this.bends[e].bounds=new mxRectangle(Math.round(c-w/2),Math.round(f-h/2),w,h)}}this.bends[e].redraw()}else{this.bends[e].destroy();this.bends[e]=null}}}};mxEdgeHandler.prototype.checkLabelHandle=function(a){if(this.labelShape!=null){var c=this.labelShape.bounds;if(mxUtils.intersects(a,c)){if(a.getCenterY()<c.getCenterY()){c.y=a.y+a.height}else{c.y=a.y-c.height}}}};mxEdgeHandler.prototype.drawPreview=function(){if(this.isLabel){var a=this.labelShape.bounds;var c=new mxRectangle(Math.round(this.label.x-a.width/2),Math.round(this.label.y-a.height/2),a.width,a.height);this.labelShape.bounds=c;this.labelShape.redraw()}else{if(this.shape!=null){this.shape.apply(this.state);this.shape.points=this.abspoints;this.shape.scale=this.state.view.scale;this.shape.isDashed=this.isSelectionDashed();this.shape.stroke=this.getSelectionColor();this.shape.strokewidth=this.getSelectionStrokeWidth()/this.shape.scale/this.shape.scale;this.shape.isShadow=false;this.shape.redraw()}}if(this.parentHighlight!=null){this.parentHighlight.redraw()}};mxEdgeHandler.prototype.refresh=function(){this.abspoints=this.getSelectionPoints(this.state);this.points=[];if(this.shape!=null){this.shape.points=this.abspoints}if(this.bends!=null){this.destroyBends(this.bends);this.bends=this.createBends()}if(this.virtualBends!=null){this.destroyBends(this.virtualBends);this.virtualBends=this.createVirtualBends()}if(this.customHandles!=null){this.destroyBends(this.customHandles);this.customHandles=this.createCustomHandles()}if(this.labelShape!=null&&this.labelShape.node!=null&&this.labelShape.node.parentNode!=null){this.labelShape.node.parentNode.appendChild(this.labelShape.node)}};mxEdgeHandler.prototype.destroyBends=function(b){if(b!=null){for(var a=0;a<b.length;a++){if(b[a]!=null){b[a].destroy()}}}};mxEdgeHandler.prototype.destroy=function(){if(this.escapeHandler!=null){this.state.view.graph.removeListener(this.escapeHandler);this.escapeHandler=null}if(this.marker!=null){this.marker.destroy();this.marker=null}if(this.shape!=null){this.shape.destroy();this.shape=null}if(this.parentHighlight!=null){this.parentHighlight.destroy();this.parentHighlight=null}if(this.labelShape!=null){this.labelShape.destroy();this.labelShape=null}if(this.constraintHandler!=null){this.constraintHandler.destroy();this.constraintHandler=null}this.destroyBends(this.virtualBends);this.virtualBends=null;this.destroyBends(this.customHandles);this.customHandles=null;this.destroyBends(this.bends);this.bends=null;this.removeHint()};